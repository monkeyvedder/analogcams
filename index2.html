<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Colecci√≥n ¬∑ C√°maras Anal√≥gicas</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üì∑</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&family=Crimson+Pro:wght@400;500;600&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        /* ============================================
           VARIABLES DE TEMA
        ============================================ */
        :root {
            --bg-body:         #16100a;
            --bg-surface:      #1e160f;
            --bg-hover:        #2a1f13;
            --bg-raised:       #231a0e;
            --border:          #3d2c1a;
            --border-subtle:   #2c2014;
            --text-main:       #e8d4b0;
            --text-muted:      #9a7f5a;
            --text-faint:      #6a5540;
            --accent:          #c89040;
            --accent-dim:      rgba(200,144,64,0.13);
            --accent-glow:     rgba(200,144,64,0.07);
            --film-bg:         #0d0906;
            --film-hole:       #16100a;

            --ok-bg:     rgba(34,110,65,0.18);    --ok-tx:     #7ecfa0;  --ok-bd:     rgba(34,110,65,0.45);
            --warn-bg:   rgba(180,120,20,0.18);   --warn-tx:   #e8b840;  --warn-bd:   rgba(180,120,20,0.45);
            --err-bg:    rgba(160,40,40,0.18);    --err-tx:    #f08080;  --err-bd:    rgba(160,40,40,0.45);
            --pend-bg:   rgba(100,60,160,0.18);   --pend-tx:   #b8a0f0;  --pend-bd:   rgba(100,60,160,0.45);
            --repair-bg: rgba(180,90,20,0.18);    --repair-tx: #f0a060;  --repair-bd: rgba(180,90,20,0.45);
        }

        [data-theme="light"] {
            --bg-body:         #ede1cb;
            --bg-surface:      #f8f0e0;
            --bg-hover:        #e4d4bc;
            --bg-raised:       #f0e6d2;
            --border:          #c4a87a;
            --border-subtle:   #dcc8a4;
            --text-main:       #2a1c0e;
            --text-muted:      #7a5a38;
            --text-faint:      #a08060;
            --accent:          #8b4e16;
            --accent-dim:      rgba(139,78,22,0.1);
            --accent-glow:     rgba(139,78,22,0.06);
            --film-bg:         #0d0906;
            --film-hole:       #ede1cb;

            --ok-bg:     rgba(34,110,65,0.12);    --ok-tx:     #1a6035;  --ok-bd:     rgba(34,110,65,0.3);
            --warn-bg:   rgba(140,80,10,0.12);    --warn-tx:   #7a4800;  --warn-bd:   rgba(140,80,10,0.3);
            --err-bg:    rgba(160,30,30,0.12);    --err-tx:    #8b1a1a;  --err-bd:    rgba(160,30,30,0.3);
            --pend-bg:   rgba(80,40,140,0.12);    --pend-tx:   #4a1a8a;  --pend-bd:   rgba(80,40,140,0.3);
            --repair-bg: rgba(160,70,10,0.12);    --repair-tx: #8b3c00;  --repair-bd: rgba(160,70,10,0.3);
        }

        /* ============================================
           RESET & BASE
        ============================================ */
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            font-family: 'Crimson Pro', Georgia, serif;
            font-size: 16px;
            line-height: 1.6;
            min-height: 100vh;
            padding-bottom: 30px;
        }

        /* ============================================
           FILM STRIP
        ============================================ */
        .filmstrip {
            height: 26px;
            background: var(--film-bg);
            background-image: radial-gradient(
                ellipse 7px 9px at 50% 50%,
                var(--film-hole) 44%,
                transparent 45%
            );
            background-size: 30px 100%;
            background-position: 5px 0;
            z-index: 200;
        }

        .filmstrip-top {
            position: sticky;
            top: 0;
        }

        .filmstrip-bottom {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
        }

        /* ============================================
           CONTENEDOR
        ============================================ */
        .container {
            max-width: 1440px;
            margin: 0 auto;
            padding: clamp(14px, 3vw, 32px);
        }

        /* ============================================
           CABECERA EDITORIAL
        ============================================ */
        .site-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
            padding-bottom: 20px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border);
            flex-wrap: wrap;
        }

        .header-brand {
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .header-logo {
            width: 50px;
            height: 50px;
            background: var(--bg-raised);
            border: 1px solid var(--border);
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            color: var(--text-muted);
        }

        .header-logo svg {
            width: 28px;
            height: 28px;
        }

        .header-titles h1 {
            font-family: 'Playfair Display', Georgia, serif;
            font-size: clamp(1.35rem, 3vw, 1.9rem);
            font-weight: 700;
            line-height: 1.1;
            letter-spacing: -0.02em;
            color: var(--text-main);
        }

        .header-meta {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 5px;
            flex-wrap: wrap;
        }

        .header-subtitle {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.65rem;
            letter-spacing: 0.16em;
            text-transform: uppercase;
            color: var(--text-muted);
        }

        .header-count-badge {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.7rem;
            color: var(--accent);
            background: var(--accent-dim);
            border: 1px solid var(--border);
            padding: 2px 9px;
            border-radius: 2px;
        }

        /* ============================================
           ESTAD√çSTICAS
        ============================================ */
        .stats-dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(105px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        @media (max-width: 640px) {
            .stats-dashboard { grid-template-columns: repeat(3, 1fr); }
        }
        @media (max-width: 400px) {
            .stats-dashboard { grid-template-columns: repeat(2, 1fr); }
        }

        .stat-card {
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: 3px;
            padding: 14px 12px 10px;
            position: relative;
            overflow: hidden;
            transition: transform 0.18s, box-shadow 0.18s;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 3px;
            background: currentColor;
            opacity: 0.7;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .stat-number {
            font-family: 'Playfair Display', Georgia, serif;
            font-size: 2.1rem;
            font-weight: 700;
            line-height: 1;
            margin-bottom: 6px;
        }

        .stat-label {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.6rem;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            color: var(--text-muted);
        }

        /* ============================================
           BARRA DE CONTROLES
        ============================================ */
        .controls-bar {
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: 3px;
            padding: 12px 14px;
            margin-bottom: 18px;
            display: flex;
            gap: 9px;
            flex-wrap: wrap;
            align-items: center;
        }

        /* ============================================
           INPUTS, SELECTS, BOTONES
        ============================================ */
        input, select, .btn {
            background: var(--bg-body);
            border: 1px solid var(--border);
            color: var(--text-main);
            padding: 7px 11px;
            border-radius: 2px;
            font-size: 0.82rem;
            font-family: 'IBM Plex Mono', monospace;
            outline: none;
            transition: border-color 0.2s, color 0.2s;
        }

        select {
            -webkit-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6' viewBox='0 0 10 6'%3E%3Cpath d='M1 1l4 4 4-4' stroke='%239a7f5a' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 9px center;
            padding-right: 26px;
        }

        input:focus, select:focus { border-color: var(--accent); }

        .search-box {
            flex: 1;
            min-width: 200px;
            padding-left: 32px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='14' viewBox='0 0 24 24' fill='none' stroke='%239a7f5a' stroke-width='2' stroke-linecap='round'%3E%3Ccircle cx='11' cy='11' r='8'/%3E%3Cline x1='21' y1='21' x2='16.65' y2='16.65'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: 10px center;
        }

        .btn { cursor: pointer; }
        .btn:hover { border-color: var(--accent); color: var(--accent); background: var(--accent-dim); }
        .btn.active { background: var(--accent); border-color: var(--accent); color: #1a0f07; }

        .icon-btn {
            padding: 7px 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .icon-btn svg { width: 15px; height: 15px; }

        .btn-group-actions {
            display: flex;
            gap: 6px;
            padding-right: 10px;
            border-right: 1px solid var(--border);
        }

        .btn-group-views {
            display: flex;
            gap: 6px;
            padding-right: 10px;
            border-right: 1px solid var(--border);
        }

        .btn-group-theme {
            display: flex;
            gap: 6px;
        }

        .group-by-label {
            display: flex;
            align-items: center;
            gap: 5px;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.72rem;
            color: var(--text-muted);
            cursor: pointer;
            user-select: none;
            padding-right: 10px;
            border-right: 1px solid var(--border);
        }

        .group-by-label input[type="checkbox"] {
            width: 13px;
            height: 13px;
            padding: 0;
            cursor: pointer;
            accent-color: var(--accent);
        }

        .group-by-label.hidden { display: none; }

        .controls-filters {
            display: flex;
            gap: 7px;
            flex-wrap: wrap;
            align-items: center;
        }

        .controls-right {
            display: flex;
            gap: 7px;
            align-items: center;
            margin-left: auto;
            flex-wrap: wrap;
        }

        /* ============================================
           BADGES (estilo estampilla)
        ============================================ */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 2px 7px;
            border-radius: 2px;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.65rem;
            font-weight: 500;
            letter-spacing: 0.07em;
            text-transform: uppercase;
            border: 1px solid;
            white-space: nowrap;
        }

        .st-ok     { background: var(--ok-bg);     color: var(--ok-tx);     border-color: var(--ok-bd);     }
        .st-warn   { background: var(--warn-bg);   color: var(--warn-tx);   border-color: var(--warn-bd);   }
        .st-err    { background: var(--err-bg);    color: var(--err-tx);    border-color: var(--err-bd);    }
        .st-pend   { background: var(--pend-bg);   color: var(--pend-tx);   border-color: var(--pend-bd);   }
        .st-repair { background: var(--repair-bg); color: var(--repair-tx); border-color: var(--repair-bd); }

        /* ============================================
           TABLA
        ============================================ */
        .table-wrapper {
            overflow-x: auto;
            border: 1px solid var(--border);
            border-radius: 3px;
            background: var(--bg-surface);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-family: 'Crimson Pro', Georgia, serif;
            font-size: 1rem;
            white-space: nowrap;
        }

        thead {
            position: sticky;
            top: 26px;
            z-index: 10;
            background: var(--bg-raised);
            border-bottom: 2px solid var(--accent);
        }

        th {
            text-align: left;
            padding: 11px 16px;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.63rem;
            text-transform: uppercase;
            letter-spacing: 0.13em;
            color: var(--text-muted);
            font-weight: 500;
            cursor: pointer;
            user-select: none;
            transition: color 0.2s;
        }

        th:hover, th.active { color: var(--accent); }
        th .sort-icon { margin-left: 4px; opacity: 0.3; font-size: 0.6rem; }
        th.active .sort-icon { opacity: 1; }
        th:focus-visible { outline: 2px solid var(--accent); outline-offset: -2px; }

        td {
            padding: 9px 16px;
            border-bottom: 1px solid var(--border-subtle);
            color: var(--text-main);
            font-size: 1rem;
        }

        tbody tr:last-child td { border-bottom: none; }
        tbody tr:hover { background: var(--accent-glow); }

        tbody tr.urgent td:first-child  { border-left: 3px solid var(--err-tx); }
        tbody tr.has-film td:first-child { border-left: 3px solid var(--warn-tx); }

        .col-brand {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.72rem;
            font-weight: 500;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            color: var(--text-muted);
        }

        .col-model {
            font-family: 'Playfair Display', Georgia, serif;
            font-size: 1rem;
            font-weight: 600;
        }

        .col-serial {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.78rem;
            color: var(--text-faint);
        }

        .col-notes {
            font-family: 'Crimson Pro', Georgia, serif;
            font-size: 0.92rem;
            color: var(--text-muted);
            font-style: italic;
            white-space: normal;
            min-width: 180px;
            max-width: 380px;
            line-height: 1.4;
        }

        /* ============================================
           VISTA CARDS (foto print)
        ============================================ */
        .view-table { display: block; }
        .view-cards { display: none; }
        body.cards-mode .view-table { display: none; }
        body.cards-mode .view-cards { display: block; }

        .cards-view {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(min(270px, 100%), 1fr));
            gap: 18px;
        }

        @media (max-width: 640px) {
            .cards-view { grid-template-columns: 1fr; gap: 14px; }
        }

        .camera-card {
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: 3px;
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        @media (hover: hover) {
            .camera-card:hover {
                transform: translateY(-3px);
                box-shadow: 0 10px 28px rgba(0,0,0,0.45);
            }
        }

        .camera-card.urgent  { border-top: 3px solid var(--err-tx);  }
        .camera-card.has-film { border-top: 3px solid var(--warn-tx); }

        /* √Årea visual de la tarjeta */
        .card-visual {
            height: 72px;
            background: var(--bg-raised);
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            color: var(--text-faint);
        }

        .card-visual::before {
            content: '';
            position: absolute;
            inset: 0;
            background:
                radial-gradient(circle at 15% 50%, var(--accent-dim) 0%, transparent 55%),
                radial-gradient(circle at 85% 50%, var(--accent-glow) 0%, transparent 55%);
        }

        .card-visual svg {
            width: 32px;
            height: 32px;
            opacity: 0.45;
            position: relative;
        }

        .card-brand-tag {
            position: absolute;
            top: 7px;
            right: 8px;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.58rem;
            font-weight: 500;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            color: var(--text-muted);
            background: var(--bg-surface);
            border: 1px solid var(--border);
            padding: 2px 6px;
            border-radius: 1px;
        }

        /* Cuerpo de tarjeta */
        .card-body {
            padding: 13px 15px 15px;
        }

        .card-header {
            margin-bottom: 11px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .card-brand {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.62rem;
            letter-spacing: 0.13em;
            text-transform: uppercase;
            color: var(--text-muted);
        }

        .card-model {
            font-family: 'Playfair Display', Georgia, serif;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-main);
            margin-top: 2px;
            line-height: 1.2;
        }

        .card-serial {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.7rem;
            color: var(--text-faint);
            margin-top: 3px;
        }

        .card-info {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-bottom: 11px;
        }

        .card-info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
        }

        /* Estilar las etiquetas de info sin tocar el JS */
        .card-info-row > span:first-child {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.62rem;
            letter-spacing: 0.09em;
            text-transform: uppercase;
            color: var(--text-faint);
        }

        .card-notes {
            font-family: 'Crimson Pro', Georgia, serif;
            font-size: 0.88rem;
            font-style: italic;
            color: var(--text-muted);
            line-height: 1.45;
            padding-top: 9px;
            border-top: 1px solid var(--border-subtle);
        }

        /* ============================================
           GRUPOS POR MARCA
        ============================================ */
        .brand-group {
            margin-bottom: 18px;
        }

        .brand-group-header {
            background: var(--bg-raised);
            border: 1px solid var(--border);
            border-radius: 3px 3px 0 0;
            padding: 10px 16px;
            font-family: 'Playfair Display', Georgia, serif;
            font-size: 1.05rem;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
            transition: background 0.2s;
        }

        .brand-group-header:hover { background: var(--bg-hover); }

        .brand-group-count {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.68rem;
            color: var(--text-muted);
            font-weight: 400;
            letter-spacing: 0.05em;
        }

        .brand-group-content {
            border: 1px solid var(--border);
            border-top: none;
            border-radius: 0 0 3px 3px;
            overflow: hidden;
        }

        .brand-group.collapsed .brand-group-content { display: none; }

        .brand-group-content thead {
            background: var(--bg-raised);
        }

        /* ============================================
           EMPTY STATE
        ============================================ */
        .empty-state {
            text-align: center;
            padding: 52px 24px;
            color: var(--text-muted);
            font-family: 'Playfair Display', Georgia, serif;
            font-style: italic;
            font-size: 1.1rem;
        }

        /* ============================================
           RESPONSIVE
        ============================================ */
        @media (max-width: 768px) {
            .site-header { flex-direction: column; align-items: flex-start; }
            .controls-bar { flex-direction: column; align-items: stretch; }
            .controls-right { margin-left: 0; }
            .search-box { min-width: 100%; }
            th { padding: 8px 10px; }
            td { padding: 8px 10px; font-size: 0.92rem; }
        }

        /* ============================================
           ANIMACIONES
        ============================================ */
        @media (prefers-reduced-motion: no-preference) {
            tbody tr {
                animation: rowIn 0.18s ease-out;
            }
            @keyframes rowIn {
                from { opacity: 0; transform: translateY(-3px); }
                to   { opacity: 1; transform: translateY(0); }
            }
            .camera-card {
                animation: cardIn 0.2s ease-out;
            }
            @keyframes cardIn {
                from { opacity: 0; transform: translateY(5px); }
                to   { opacity: 1; transform: translateY(0); }
            }
        }

        /* ============================================
           PRINT
        ============================================ */
        @media print {
            .filmstrip, .controls-bar, .stats-dashboard, .filmstrip-bottom { display: none; }
            body { background: white; color: black; padding-bottom: 0; }
            .table-wrapper { border: 1px solid #000; }
        }
    </style>
</head>
<body>

<!-- Film strip superior (sticky) -->
<div class="filmstrip filmstrip-top"></div>

<div class="container">

    <!-- Cabecera editorial -->
    <header class="site-header">
        <div class="header-brand">
            <div class="header-logo">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
                    <circle cx="12" cy="13" r="4"/>
                </svg>
            </div>
            <div class="header-titles">
                <h1>Colecci√≥n de C√°maras</h1>
                <div class="header-meta">
                    <span class="header-subtitle">Cat√°logo anal√≥gico personal</span>
                    <span class="header-count-badge"><span id="countDisplay" role="status" aria-live="polite">0</span> c√°maras</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Dashboard de Estad√≠sticas -->
    <div class="stats-dashboard" id="statsDashboard"></div>

    <!-- Barra de controles -->
    <div class="controls-bar header-controls">
        <input type="search" id="searchInput" class="search-box" placeholder="Buscar marca, modelo, notas‚Ä¶" aria-label="Buscar c√°maras">

        <div class="controls-filters">
            <select id="brandFilter" aria-label="Filtrar por marca">
                <option value="all">Todas las Marcas</option>
            </select>

            <select id="statusFilter" aria-label="Filtrar por estado">
                <option value="all">Todos los estados</option>
                <option value="ok">Funcional</option>
                <option value="warning">Detalles</option>
                <option value="error">Reparar</option>
                <option value="repair">En reparaci√≥n</option>
                <option value="pending">Pendiente</option>
            </select>

            <select id="speedsFilter" aria-label="Filtrar por velocidades">
                <option value="all">Velocidades</option>
                <option value="ok">Correctas</option>
                <option value="bad">Fallan</option>
                <option value="unknown">N/D</option>
            </select>

            <select id="filmFilter" aria-label="Filtrar por carrete">
                <option value="all">Carrete</option>
                <option value="yes">Probado</option>
                <option value="no">No probado</option>
            </select>
        </div>

        <div class="controls-right">
            <div class="btn-group-actions">
                <button type="button" id="resetBtn" class="btn icon-btn" aria-label="Resetear filtros" title="Resetear filtros">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/>
                        <path d="M21 3v5h-5"/>
                        <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/>
                        <path d="M3 21v-5h5"/>
                    </svg>
                </button>
                <button type="button" id="exportBtn" class="btn icon-btn" aria-label="Exportar CSV" title="Exportar CSV">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="7 10 12 15 17 10"/>
                        <line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                </button>
                <button type="button" id="printBtn" class="btn icon-btn" aria-label="Imprimir" title="Imprimir">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="6 9 6 2 18 2 18 9"/>
                        <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/>
                        <rect x="6" y="14" width="12" height="8"/>
                    </svg>
                </button>
            </div>

            <div class="btn-group-views">
                <button type="button" id="tableViewBtn" class="btn icon-btn active" aria-label="Vista tabla" title="Vista tabla">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                        <line x1="3" y1="9" x2="21" y2="9"/>
                        <line x1="9" y1="21" x2="9" y2="9"/>
                    </svg>
                </button>
                <button type="button" id="cardsViewBtn" class="btn icon-btn" aria-label="Vista tarjetas" title="Vista tarjetas">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="3" width="7" height="7"/>
                        <rect x="14" y="3" width="7" height="7"/>
                        <rect x="14" y="14" width="7" height="7"/>
                        <rect x="3" y="14" width="7" height="7"/>
                    </svg>
                </button>
            </div>

            <label class="group-by-label" id="groupByLabel">
                <input type="checkbox" id="groupByBrand"> Agrupar
            </label>

            <div class="btn-group-theme">
                <a href="index.html" class="btn" style="text-decoration:none;font-size:0.78rem;padding:7px 11px;" title="Ver dise√±o original">‚Üê v1</a>
                <button type="button" id="themeBtn" class="btn icon-btn" aria-label="Cambiar tema" title="Cambiar tema">
                    <svg class="theme-icon-dark" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                    </svg>
                    <svg class="theme-icon-light" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:none">
                        <circle cx="12" cy="12" r="5"/>
                        <line x1="12" y1="1" x2="12" y2="3"/>
                        <line x1="12" y1="21" x2="12" y2="23"/>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
                        <line x1="1" y1="12" x2="3" y2="12"/>
                        <line x1="21" y1="12" x2="23" y2="12"/>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Vista Tabla -->
    <div class="view-table">
        <div class="table-wrapper" id="tableContainer">
            <table role="grid" aria-label="Colecci√≥n de c√°maras anal√≥gicas">
                <thead>
                    <tr>
                        <th data-col="brand"  tabindex="0" role="columnheader" aria-sort="ascending">Marca <span class="sort-icon" aria-hidden="true">‚áÖ</span></th>
                        <th data-col="model"  tabindex="0" role="columnheader">Modelo <span class="sort-icon" aria-hidden="true">‚áÖ</span></th>
                        <th data-col="serial" tabindex="0" role="columnheader">N¬∫ Serie <span class="sort-icon" aria-hidden="true">‚áÖ</span></th>
                        <th data-col="status" tabindex="0" role="columnheader">Estado <span class="sort-icon" aria-hidden="true">‚áÖ</span></th>
                        <th data-col="speeds" tabindex="0" role="columnheader">Velocidades <span class="sort-icon" aria-hidden="true">‚áÖ</span></th>
                        <th data-col="film"   tabindex="0" role="columnheader">Carrete <span class="sort-icon" aria-hidden="true">‚áÖ</span></th>
                        <th data-col="loaded" tabindex="0" role="columnheader">Con Carrete <span class="sort-icon" aria-hidden="true">‚áÖ</span></th>
                        <th data-col="notes"  tabindex="0" role="columnheader">Observaciones <span class="sort-icon" aria-hidden="true">‚áÖ</span></th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

    <!-- Vista Cards -->
    <div class="view-cards">
        <div class="cards-view" id="cardsContainer"></div>
    </div>

</div>

<!-- Film strip inferior (fixed) -->
<div class="filmstrip filmstrip-bottom"></div>

<script>
(function() {
    'use strict';

    // ============================================
    // DATOS (cargados desde JSON)
    // ============================================
    let CAMERAS = [];

    const CONFIG = Object.freeze({
        status: {
            ok:      { label: 'Funcional',      cssClass: 'st-ok' },
            warning: { label: 'Detalles',       cssClass: 'st-warn' },
            error:   { label: 'Reparar',        cssClass: 'st-err' },
            repair:  { label: 'En reparaci√≥n',  cssClass: 'st-repair' },
            pending: { label: 'Por Revelar',    cssClass: 'st-pend' }
        },
        speeds: {
            ok:      { label: 'Correctas', cssClass: 'st-ok' },
            bad:     { label: 'Fallan',    cssClass: 'st-err' },
            unknown: { label: 'N/D',       cssClass: 'st-pend' }
        },
        film: {
            yes: { label: 'Probado',    cssClass: 'st-ok' },
            no:  { label: 'No probado', cssClass: 'st-pend' }
        },
        loaded: {
            yes: { label: 'S√≠', cssClass: 'st-warn' },
            no:  { label: 'No', cssClass: 'st-pend' }
        },
        defaults: { speeds: 'unknown', film: 'no', loaded: 'no' },
        storageKey: 'cameraCollection.v3'
    });

    // ============================================
    // UTILIDADES
    // ============================================
    const collator = new Intl.Collator('es', { sensitivity: 'base', numeric: true });

    const Utils = {
        compareText: (a, b) => collator.compare(String(a ?? ''), String(b ?? '')),

        normalize: (value) => String(value ?? '')
            .toLowerCase()
            .normalize('NFD')
            .replace(/\p{Diacritic}/gu, '')
            .trim(),

        debounce(fn, delay = 150) {
            let timeoutId;
            return (...args) => {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => fn(...args), delay);
            };
        },

        parseSerial(serial) {
            const s = String(serial ?? '').trim();
            if (!s || s === '-') return null;
            const n = parseInt(s, 10);
            return Number.isFinite(n) ? n : null;
        },

        buildSearchIndex(cam) {
            const { status, speeds, film, loaded } = CONFIG;
            const statusCfg = status[cam.status] ?? {};
            const speedsCfg = speeds[cam.speeds ?? CONFIG.defaults.speeds] ?? {};
            const filmCfg   = film[cam.film ?? CONFIG.defaults.film] ?? {};
            const loadedCfg = loaded[cam.loaded ?? CONFIG.defaults.loaded] ?? {};

            return Utils.normalize([
                cam.brand, cam.model, cam.serial, cam.notes,
                cam.status, statusCfg.label,
                cam.speeds, speedsCfg.label,
                cam.film,   filmCfg.label,
                cam.loaded, loadedCfg.label
            ].join(' '));
        }
    };

    let searchIndexes = new Map();

    // ============================================
    // DOM
    // ============================================
    const $ = (s) => document.querySelector(s);
    const $$ = (s) => document.querySelectorAll(s);

    const DOM = {
        tableBody:      $('#tableBody'),
        cardsContainer: $('#cardsContainer'),
        tableContainer: $('#tableContainer'),
        statsDashboard: $('#statsDashboard'),
        searchInput:    $('#searchInput'),
        brandFilter:    $('#brandFilter'),
        statusFilter:   $('#statusFilter'),
        speedsFilter:   $('#speedsFilter'),
        filmFilter:     $('#filmFilter'),
        resetBtn:       $('#resetBtn'),
        exportBtn:      $('#exportBtn'),
        printBtn:       $('#printBtn'),
        themeBtn:       $('#themeBtn'),
        tableViewBtn:   $('#tableViewBtn'),
        cardsViewBtn:   $('#cardsViewBtn'),
        groupByBrand:   $('#groupByBrand'),
        groupByLabel:   $('#groupByLabel'),
        countDisplay:   $('#countDisplay'),
        headers:        $$('th[data-col]')
    };

    // ============================================
    // ESTADO
    // ============================================
    const state = {
        sort:        { column: 'brand', direction: 'asc' },
        view:        'table',
        theme:       'dark',
        groupByBrand: false
    };

    // ============================================
    // L√ìGICA DE NEGOCIO
    // ============================================
    const getFilters = () => ({
        search: Utils.normalize(DOM.searchInput.value),
        brand:  DOM.brandFilter.value,
        status: DOM.statusFilter.value,
        speeds: DOM.speedsFilter.value,
        film:   DOM.filmFilter.value
    });

    const filterCameras = (cameras, filters) => {
        const { search, brand, status, speeds, film } = filters;
        return cameras.filter(cam => {
            if (search && !searchIndexes.get(cam).includes(search)) return false;
            if (brand  !== 'all' && cam.brand  !== brand)  return false;
            if (status !== 'all' && cam.status !== status) return false;
            if (speeds !== 'all' && (cam.speeds ?? CONFIG.defaults.speeds) !== speeds) return false;
            if (film   !== 'all' && (cam.film   ?? CONFIG.defaults.film)   !== film)   return false;
            return true;
        });
    };

    const sortCameras = (cameras, { column, direction }) => {
        const dir = direction === 'asc' ? 1 : -1;
        const comparators = {
            serial: (a, b) => {
                const nA = Utils.parseSerial(a.serial);
                const nB = Utils.parseSerial(b.serial);
                if (nA === null && nB === null) return 0;
                if (nA === null) return 1;
                if (nB === null) return -1;
                return nA - nB;
            },
            status:  (a, b) => Utils.compareText(CONFIG.status[a.status]?.label ?? '', CONFIG.status[b.status]?.label ?? ''),
            speeds:  (a, b) => Utils.compareText(CONFIG.speeds[a.speeds ?? CONFIG.defaults.speeds]?.label ?? '', CONFIG.speeds[b.speeds ?? CONFIG.defaults.speeds]?.label ?? ''),
            film:    (a, b) => Utils.compareText(CONFIG.film[a.film ?? CONFIG.defaults.film]?.label ?? '', CONFIG.film[b.film ?? CONFIG.defaults.film]?.label ?? ''),
            loaded:  (a, b) => Utils.compareText(CONFIG.loaded[a.loaded ?? CONFIG.defaults.loaded]?.label ?? '', CONFIG.loaded[b.loaded ?? CONFIG.defaults.loaded]?.label ?? ''),
            default: (a, b) => Utils.compareText(a[column] ?? '', b[column] ?? '')
        };
        const compare = comparators[column] ?? comparators.default;
        return [...cameras].sort((a, b) => {
            const cmp = compare(a, b);
            if (cmp !== 0) return cmp * dir;
            return Utils.compareText(`${a.brand} ${a.model} ${a.serial}`, `${b.brand} ${b.model} ${b.serial}`);
        });
    };

    // ============================================
    // RENDERIZADO
    // ============================================
    const createBadge = (text, cssClass) => {
        const span = document.createElement('span');
        span.className = `badge ${cssClass}`;
        span.textContent = text;
        return span;
    };

    const createCell = (text, className) => {
        const td = document.createElement('td');
        if (className) td.className = className;
        td.textContent = text;
        return td;
    };

    const createRow = (cam) => {
        const tr = document.createElement('tr');
        const st = CONFIG.status[cam.status];
        const sp = CONFIG.speeds[cam.speeds ?? CONFIG.defaults.speeds];
        const fm = CONFIG.film[cam.film ?? CONFIG.defaults.film];
        const ld = CONFIG.loaded[cam.loaded ?? CONFIG.defaults.loaded];

        if (cam.status === 'error') tr.classList.add('urgent');
        if (cam.loaded === 'yes')   tr.classList.add('has-film');

        tr.appendChild(createCell(cam.brand,  'col-brand'));
        tr.appendChild(createCell(cam.model,  'col-model'));
        tr.appendChild(createCell(cam.serial, 'col-serial'));

        const statusCell = document.createElement('td');
        statusCell.appendChild(createBadge(st.label, st.cssClass));
        tr.appendChild(statusCell);

        const speedsCell = document.createElement('td');
        speedsCell.appendChild(createBadge(sp.label, sp.cssClass));
        tr.appendChild(speedsCell);

        const filmCell = document.createElement('td');
        filmCell.appendChild(createBadge(fm.label, fm.cssClass));
        tr.appendChild(filmCell);

        const loadedCell = document.createElement('td');
        loadedCell.appendChild(createBadge(ld.label, ld.cssClass));
        tr.appendChild(loadedCell);

        tr.appendChild(createCell(cam.notes, 'col-notes'));
        return tr;
    };

    // SVG de c√°mara para el √°rea visual de la tarjeta
    const CAMERA_SVG = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
        <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
        <circle cx="12" cy="13" r="4"/>
    </svg>`;

    const createCard = (cam) => {
        const card = document.createElement('div');
        card.className = 'camera-card';

        if (cam.status === 'error') card.classList.add('urgent');
        if (cam.loaded === 'yes')   card.classList.add('has-film');

        const st = CONFIG.status[cam.status];
        const sp = CONFIG.speeds[cam.speeds ?? CONFIG.defaults.speeds];
        const fm = CONFIG.film[cam.film ?? CONFIG.defaults.film];
        const ld = CONFIG.loaded[cam.loaded ?? CONFIG.defaults.loaded];

        // √Årea visual
        const visual = document.createElement('div');
        visual.className = 'card-visual';
        visual.innerHTML = CAMERA_SVG;

        const brandTag = document.createElement('div');
        brandTag.className = 'card-brand-tag';
        brandTag.textContent = cam.brand;
        visual.appendChild(brandTag);

        // Cuerpo
        const body = document.createElement('div');
        body.className = 'card-body';

        // Header
        const header = document.createElement('div');
        header.className = 'card-header';

        const brandDiv = document.createElement('div');
        brandDiv.className = 'card-brand';
        brandDiv.textContent = cam.brand;

        const modelDiv = document.createElement('div');
        modelDiv.className = 'card-model';
        modelDiv.textContent = cam.model;

        const serialDiv = document.createElement('div');
        serialDiv.className = 'card-serial';
        serialDiv.textContent = `S/N: ${cam.serial}`;

        header.appendChild(brandDiv);
        header.appendChild(modelDiv);
        header.appendChild(serialDiv);

        // Info rows
        const info = document.createElement('div');
        info.className = 'card-info';

        const createInfoRow = (label, badge) => {
            const row = document.createElement('div');
            row.className = 'card-info-row';
            const labelSpan = document.createElement('span');
            labelSpan.textContent = label;
            row.appendChild(labelSpan);
            row.appendChild(badge);
            return row;
        };

        info.appendChild(createInfoRow('Estado:',      createBadge(st.label, st.cssClass)));
        info.appendChild(createInfoRow('Velocidades:', createBadge(sp.label, sp.cssClass)));
        info.appendChild(createInfoRow('Carrete:',     createBadge(fm.label, fm.cssClass)));
        info.appendChild(createInfoRow('Cargada:',     createBadge(ld.label, ld.cssClass)));

        // Notes
        const notes = document.createElement('div');
        notes.className = 'card-notes';
        notes.textContent = cam.notes || 'Sin observaciones';

        body.appendChild(header);
        body.appendChild(info);
        body.appendChild(notes);

        card.appendChild(visual);
        card.appendChild(body);
        return card;
    };

    // Colores para las stat cards (top bar via currentColor)
    const STAT_COLORS = {
        total:    'var(--accent)',
        ok:       'var(--ok-tx)',
        warning:  'var(--warn-tx)',
        error:    'var(--err-tx)',
        repair:   'var(--repair-tx)',
        withFilm: 'var(--warn-tx)'
    };

    const renderStats = (cameras) => {
        const stats = {
            total:    cameras.length,
            ok:       cameras.filter(c => c.status === 'ok').length,
            warning:  cameras.filter(c => c.status === 'warning').length,
            error:    cameras.filter(c => c.status === 'error').length,
            repair:   cameras.filter(c => c.status === 'repair').length,
            withFilm: cameras.filter(c => c.loaded === 'yes').length
        };

        const dashboard = DOM.statsDashboard;
        dashboard.innerHTML = '';

        const items = [
            { key: 'total',    value: stats.total,    label: 'Total' },
            { key: 'ok',       value: stats.ok,       label: 'Funcionales' },
            { key: 'warning',  value: stats.warning,  label: 'Detalles' },
            { key: 'error',    value: stats.error,    label: 'A reparar' },
            { key: 'repair',   value: stats.repair,   label: 'En taller' },
            { key: 'withFilm', value: stats.withFilm, label: 'Cargadas' }
        ];

        const fragment = document.createDocumentFragment();
        items.forEach(({ key, value, label }) => {
            const card = document.createElement('div');
            card.className = 'stat-card';
            card.style.color = STAT_COLORS[key];

            const num = document.createElement('div');
            num.className = 'stat-number';
            num.textContent = value;

            const lbl = document.createElement('div');
            lbl.className = 'stat-label';
            lbl.textContent = label;

            card.appendChild(num);
            card.appendChild(lbl);
            fragment.appendChild(card);
        });

        dashboard.appendChild(fragment);
    };

    const renderTable = (cameras) => {
        const tbody = DOM.tableBody;
        tbody.innerHTML = '';

        if (cameras.length === 0) {
            const tr = document.createElement('tr');
            const td = document.createElement('td');
            td.colSpan = 8;
            td.className = 'empty-state';
            td.textContent = 'No se encontraron c√°maras con los filtros seleccionados';
            tr.appendChild(td);
            tbody.appendChild(tr);
        } else {
            const fragment = document.createDocumentFragment();
            cameras.forEach(cam => fragment.appendChild(createRow(cam)));
            tbody.appendChild(fragment);
        }

        DOM.countDisplay.textContent = cameras.length;
    };

    const renderCards = (cameras) => {
        const container = DOM.cardsContainer;
        container.innerHTML = '';

        if (cameras.length === 0) {
            const empty = document.createElement('div');
            empty.className = 'empty-state';
            empty.textContent = 'No se encontraron c√°maras con los filtros seleccionados';
            container.appendChild(empty);
        } else {
            const fragment = document.createDocumentFragment();
            cameras.forEach(cam => fragment.appendChild(createCard(cam)));
            container.appendChild(fragment);
        }

        DOM.countDisplay.textContent = cameras.length;
    };

    const sortByPriority = (a, b) => {
        if (a.status === 'repair'  && b.status !== 'repair')  return -1;
        if (a.status !== 'repair'  && b.status === 'repair')  return 1;
        if (a.status === 'error'   && b.status !== 'error')   return -1;
        if (a.status !== 'error'   && b.status === 'error')   return 1;
        if (a.loaded === 'yes'     && b.loaded !== 'yes')     return -1;
        if (a.loaded !== 'yes'     && b.loaded === 'yes')     return 1;
        if (a.status === 'warning' && b.status !== 'warning') return -1;
        if (a.status !== 'warning' && b.status === 'warning') return 1;
        if (a.status === 'pending' && b.status !== 'pending') return -1;
        if (a.status !== 'pending' && b.status === 'pending') return 1;
        return Utils.compareText(a.model, b.model);
    };

    const renderGroupedTable = (cameras) => {
        let groupedContainer = document.getElementById('groupedTableContainer');
        if (!groupedContainer) {
            groupedContainer = document.createElement('div');
            groupedContainer.id = 'groupedTableContainer';
            DOM.tableContainer.parentNode.appendChild(groupedContainer);
        }

        groupedContainer.innerHTML = '';

        if (cameras.length === 0) {
            const empty = document.createElement('div');
            empty.className = 'empty-state';
            empty.textContent = 'No se encontraron c√°maras con los filtros seleccionados';
            groupedContainer.appendChild(empty);
            DOM.countDisplay.textContent = 0;
            return;
        }

        const groups = {};
        cameras.forEach(cam => {
            if (!groups[cam.brand]) groups[cam.brand] = [];
            groups[cam.brand].push(cam);
        });

        const fragment = document.createDocumentFragment();
        Object.keys(groups).sort(Utils.compareText).forEach(brand => {
            const brandCameras = groups[brand].sort(sortByPriority);

            const group = document.createElement('div');
            group.className = 'brand-group';

            const header = document.createElement('div');
            header.className = 'brand-group-header';
            const titleSpan = document.createElement('span');
            titleSpan.textContent = brand;
            const countSpan = document.createElement('span');
            countSpan.className = 'brand-group-count';
            countSpan.textContent = `${brandCameras.length} c√°mara${brandCameras.length > 1 ? 's' : ''}`;
            header.appendChild(titleSpan);
            header.appendChild(countSpan);
            header.addEventListener('click', () => group.classList.toggle('collapsed'));

            const content = document.createElement('div');
            content.className = 'brand-group-content';

            const table = document.createElement('table');
            table.innerHTML = `
                <thead><tr>
                    <th>Modelo</th>
                    <th>N¬∫ Serie</th>
                    <th>Estado</th>
                    <th>Velocidades</th>
                    <th>Carrete</th>
                    <th>Con Carrete</th>
                    <th>Observaciones</th>
                </tr></thead>
            `;

            const tbody = document.createElement('tbody');
            brandCameras.forEach(cam => {
                const tr = document.createElement('tr');
                if (cam.status === 'error') tr.classList.add('urgent');
                if (cam.loaded === 'yes')   tr.classList.add('has-film');

                const st = CONFIG.status[cam.status];
                const sp = CONFIG.speeds[cam.speeds ?? CONFIG.defaults.speeds];
                const fm = CONFIG.film[cam.film ?? CONFIG.defaults.film];
                const ld = CONFIG.loaded[cam.loaded ?? CONFIG.defaults.loaded];

                tr.appendChild(createCell(cam.model,  'col-model'));
                tr.appendChild(createCell(cam.serial, 'col-serial'));

                const statusCell = document.createElement('td');
                statusCell.appendChild(createBadge(st.label, st.cssClass));
                tr.appendChild(statusCell);

                const speedsCell = document.createElement('td');
                speedsCell.appendChild(createBadge(sp.label, sp.cssClass));
                tr.appendChild(speedsCell);

                const filmCell = document.createElement('td');
                filmCell.appendChild(createBadge(fm.label, fm.cssClass));
                tr.appendChild(filmCell);

                const loadedCell = document.createElement('td');
                loadedCell.appendChild(createBadge(ld.label, ld.cssClass));
                tr.appendChild(loadedCell);

                tr.appendChild(createCell(cam.notes, 'col-notes'));
                tbody.appendChild(tr);
            });

            table.appendChild(tbody);
            content.appendChild(table);
            group.appendChild(header);
            group.appendChild(content);
            fragment.appendChild(group);
        });

        groupedContainer.appendChild(fragment);
        DOM.countDisplay.textContent = cameras.length;
    };

    const updateHeaderIcons = () => {
        DOM.headers.forEach(th => {
            const col = th.dataset.col;
            const isActive = col === state.sort.column;
            const icon = th.querySelector('.sort-icon');
            th.classList.toggle('active', isActive);
            th.setAttribute('aria-sort', isActive ? (state.sort.direction === 'asc' ? 'ascending' : 'descending') : 'none');
            icon.textContent = isActive ? (state.sort.direction === 'asc' ? '‚Üë' : '‚Üì') : '‚áÖ';
        });
    };

    const render = () => {
        const filters = getFilters();
        const filtered = filterCameras(CAMERAS, filters);
        const sorted   = sortCameras(filtered, state.sort);

        renderStats(CAMERAS);

        const groupedContainer = document.getElementById('groupedTableContainer');

        if (state.groupByBrand && state.view === 'table') {
            DOM.tableContainer.style.display = 'none';
            if (groupedContainer) groupedContainer.style.display = '';
            renderGroupedTable(sorted);
        } else if (state.view === 'table') {
            if (groupedContainer) groupedContainer.style.display = 'none';
            DOM.tableContainer.style.display = '';
            renderTable(sorted);
        } else {
            if (groupedContainer) groupedContainer.style.display = 'none';
            DOM.tableContainer.style.display = 'none';
            renderCards(sorted);
        }

        updateHeaderIcons();
    };

    const scheduleRender = Utils.debounce(render, 150);

    // ============================================
    // PERSISTENCIA
    // ============================================
    const Storage = {
        save() {
            const payload = {
                sort: state.sort,
                view: state.view,
                theme: state.theme,
                groupByBrand: state.groupByBrand,
                filters: {
                    search: DOM.searchInput.value,
                    brand:  DOM.brandFilter.value,
                    status: DOM.statusFilter.value,
                    speeds: DOM.speedsFilter.value,
                    film:   DOM.filmFilter.value
                }
            };
            try { localStorage.setItem(CONFIG.storageKey, JSON.stringify(payload)); } catch {}
        },

        load() {
            try {
                const raw = localStorage.getItem(CONFIG.storageKey);
                if (!raw) return;
                const data = JSON.parse(raw);
                if (data?.sort?.column)          state.sort        = data.sort;
                if (data?.view)                  state.view        = data.view;
                if (data?.theme)                 state.theme       = data.theme;
                if (data?.groupByBrand !== undefined) state.groupByBrand = data.groupByBrand;
                if (data?.filters) {
                    const f = data.filters;
                    DOM.searchInput.value  = f.search ?? '';
                    DOM.brandFilter.value  = f.brand  ?? 'all';
                    DOM.statusFilter.value = f.status ?? 'all';
                    DOM.speedsFilter.value = f.speeds ?? 'all';
                    DOM.filmFilter.value   = f.film   ?? 'all';
                }
            } catch {}
        }
    };

    // ============================================
    // CARGA DE DATOS
    // ============================================
    const loadCameras = async () => {
        try {
            const response = await fetch('cameras.json');
            if (!response.ok) throw new Error('Error al cargar datos');
            const data = await response.json();
            CAMERAS = Object.freeze(data);
            searchIndexes = new Map(CAMERAS.map(cam => [cam, Utils.buildSearchIndex(cam)]));
            return true;
        } catch (error) {
            console.error('Error cargando c√°maras:', error);
            DOM.tableBody.innerHTML = `
                <tr><td colspan="8" class="empty-state">
                    Error al cargar los datos. Por favor, recarga la p√°gina.
                </td></tr>
            `;
            return false;
        }
    };

    // ============================================
    // INICIALIZACI√ìN
    // ============================================
    const populateBrandFilter = () => {
        const brands = [...new Set(CAMERAS.map(c => c.brand))].sort(Utils.compareText);
        const fragment = document.createDocumentFragment();
        const allOption = document.createElement('option');
        allOption.value = 'all';
        allOption.textContent = 'Todas las Marcas';
        fragment.appendChild(allOption);
        brands.forEach(brand => {
            const opt = document.createElement('option');
            opt.value = brand;
            opt.textContent = brand;
            fragment.appendChild(opt);
        });
        DOM.brandFilter.innerHTML = '';
        DOM.brandFilter.appendChild(fragment);
    };

    const resetFilters = () => {
        DOM.searchInput.value  = '';
        DOM.brandFilter.value  = 'all';
        DOM.statusFilter.value = 'all';
        DOM.speedsFilter.value = 'all';
        DOM.filmFilter.value   = 'all';
        state.sort = { column: 'brand', direction: 'asc' };
        Storage.save();
        render();
        DOM.searchInput.focus();
    };

    const applyTheme = () => {
        document.documentElement.setAttribute('data-theme', state.theme);
        const darkIcon  = DOM.themeBtn.querySelector('.theme-icon-dark');
        const lightIcon = DOM.themeBtn.querySelector('.theme-icon-light');
        if (state.theme === 'dark') {
            darkIcon.style.display  = '';
            lightIcon.style.display = 'none';
        } else {
            darkIcon.style.display  = 'none';
            lightIcon.style.display = '';
        }
    };

    const toggleTheme = () => {
        state.theme = state.theme === 'dark' ? 'light' : 'dark';
        applyTheme();
        Storage.save();
    };

    const toggleView = (view) => {
        state.view = view;
        document.body.classList.toggle('cards-mode', view === 'cards');
        DOM.tableViewBtn.classList.toggle('active', view === 'table');
        DOM.cardsViewBtn.classList.toggle('active', view === 'cards');
        DOM.groupByLabel.classList.toggle('hidden', view === 'cards');
        Storage.save();
        render();
    };

    const toggleGrouping = () => {
        state.groupByBrand = DOM.groupByBrand.checked;
        Storage.save();
        render();
    };

    const exportToCSV = () => {
        const filters = getFilters();
        const filtered = filterCameras(CAMERAS, filters);
        const sorted   = sortCameras(filtered, state.sort);

        const headers = ['Marca','Modelo','N¬∫ Serie','Estado','Velocidades','Carrete','Con Carrete','Observaciones'];
        const rows = sorted.map(cam => {
            const st = CONFIG.status[cam.status]?.label ?? '';
            const sp = CONFIG.speeds[cam.speeds ?? CONFIG.defaults.speeds]?.label ?? '';
            const fm = CONFIG.film[cam.film ?? CONFIG.defaults.film]?.label ?? '';
            const ld = CONFIG.loaded[cam.loaded ?? CONFIG.defaults.loaded]?.label ?? '';
            return [cam.brand, cam.model, cam.serial, st, sp, fm, ld, cam.notes]
                .map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',');
        });

        const csv  = [headers.join(','), ...rows].join('\n');
        const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href  = URL.createObjectURL(blob);
        link.download = `camaras_${new Date().toISOString().split('T')[0]}.csv`;
        link.click();
        URL.revokeObjectURL(link.href);
    };

    const handleSort = (column) => {
        if (state.sort.column === column) {
            state.sort.direction = state.sort.direction === 'asc' ? 'desc' : 'asc';
        } else {
            state.sort.column    = column;
            state.sort.direction = 'asc';
        }
        Storage.save();
        render();
    };

    const init = async () => {
        DOM.tableBody.innerHTML = `
            <tr><td colspan="8" class="empty-state">Cargando datos‚Ä¶</td></tr>
        `;

        const loaded = await loadCameras();
        if (!loaded) return;

        populateBrandFilter();
        Storage.load();
        applyTheme();

        document.body.classList.toggle('cards-mode', state.view === 'cards');
        DOM.tableViewBtn.classList.toggle('active', state.view === 'table');
        DOM.cardsViewBtn.classList.toggle('active', state.view === 'cards');
        DOM.groupByLabel.classList.toggle('hidden',  state.view === 'cards');
        DOM.groupByBrand.checked = state.groupByBrand;

        // Event listeners
        DOM.searchInput.addEventListener('input',  () => { Storage.save(); scheduleRender(); });
        [DOM.brandFilter, DOM.statusFilter, DOM.speedsFilter, DOM.filmFilter].forEach(el => {
            el.addEventListener('change', () => { Storage.save(); render(); });
        });

        DOM.resetBtn.addEventListener('click',      resetFilters);
        DOM.exportBtn.addEventListener('click',     exportToCSV);
        DOM.printBtn.addEventListener('click',      () => window.print());
        DOM.themeBtn.addEventListener('click',      toggleTheme);
        DOM.tableViewBtn.addEventListener('click',  () => toggleView('table'));
        DOM.cardsViewBtn.addEventListener('click',  () => toggleView('cards'));
        DOM.groupByBrand.addEventListener('change', toggleGrouping);

        const thead = document.querySelector('thead');
        thead.addEventListener('click', e => {
            const th = e.target.closest('th[data-col]');
            if (th) handleSort(th.dataset.col);
        });
        thead.addEventListener('keydown', e => {
            const th = e.target.closest('th[data-col]');
            if (th && (e.key === 'Enter' || e.key === ' ')) {
                e.preventDefault();
                handleSort(th.dataset.col);
            }
        });

        render();
    };

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }
})();
</script>
</body>
</html>
