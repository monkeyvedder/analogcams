<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C√°maras Anal√≥gicas ‚Äî Dashboard</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üì∑</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        /* ============================================
           VARIABLES
        ============================================ */
        :root {
            --bg-body:       #09090b;
            --bg-surface:    #18181b;
            --bg-hover:      #27272a;
            --bg-raised:     #1c1c1f;
            --border:        #3f3f46;
            --border-subtle: #27272a;
            --text-main:     #f4f4f5;
            --text-muted:    #a1a1aa;
            --text-faint:    #71717a;
            --accent:        #8b5cf6;
            --accent-dim:    rgba(139,92,246,0.14);
            --accent-glow:   rgba(139,92,246,0.06);

            --ok-color:     #22c55e;
            --warn-color:   #f59e0b;
            --err-color:    #ef4444;
            --pend-color:   #a855f7;
            --repair-color: #f97316;

            --ok-bg:     rgba(34,197,94,0.1);    --ok-tx:     #86efac;   --ok-bd:     rgba(34,197,94,0.3);
            --warn-bg:   rgba(245,158,11,0.1);   --warn-tx:   #fcd34d;   --warn-bd:   rgba(245,158,11,0.3);
            --err-bg:    rgba(239,68,68,0.1);    --err-tx:    #fca5a5;   --err-bd:    rgba(239,68,68,0.3);
            --pend-bg:   rgba(168,85,247,0.1);   --pend-tx:   #d8b4fe;   --pend-bd:   rgba(168,85,247,0.3);
            --repair-bg: rgba(249,115,22,0.1);   --repair-tx: #fed7aa;   --repair-bd: rgba(249,115,22,0.3);
        }

        [data-theme="light"] {
            --bg-body:       #fafafa;
            --bg-surface:    #ffffff;
            --bg-hover:      #f4f4f5;
            --bg-raised:     #f7f7f8;
            --border:        #e4e4e7;
            --border-subtle: #f4f4f5;
            --text-main:     #09090b;
            --text-muted:    #71717a;
            --text-faint:    #a1a1aa;
            --accent:        #7c3aed;
            --accent-dim:    rgba(124,58,237,0.08);
            --accent-glow:   rgba(124,58,237,0.04);

            --ok-bg:     rgba(34,197,94,0.08);    --ok-tx:     #166534;   --ok-bd:     rgba(34,197,94,0.25);
            --warn-bg:   rgba(245,158,11,0.08);   --warn-tx:   #92400e;   --warn-bd:   rgba(245,158,11,0.25);
            --err-bg:    rgba(239,68,68,0.08);    --err-tx:    #7f1d1d;   --err-bd:    rgba(239,68,68,0.25);
            --pend-bg:   rgba(168,85,247,0.08);   --pend-tx:   #4c1d95;   --pend-bd:   rgba(168,85,247,0.25);
            --repair-bg: rgba(249,115,22,0.08);   --repair-tx: #7c2d12;   --repair-bd: rgba(249,115,22,0.25);
        }

        /* ============================================
           RESET & BASE
        ============================================ */
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background: var(--bg-body);
            color: var(--text-main);
            font-family: 'DM Sans', system-ui, sans-serif;
            font-size: 14px;
            line-height: 1.5;
            min-height: 100vh;
        }

        .container {
            max-width: 1440px;
            margin: 0 auto;
            padding: clamp(16px, 3vw, 28px);
        }

        /* ============================================
           CABECERA
        ============================================ */
        .app-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            padding-bottom: 20px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-subtle);
            flex-wrap: wrap;
        }

        .app-brand {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .brand-icon {
            width: 36px;
            height: 36px;
            background: var(--accent-dim);
            border: 1px solid var(--border);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--accent);
            flex-shrink: 0;
        }

        .brand-icon svg { width: 18px; height: 18px; }

        .brand-text h1 {
            font-size: 1rem;
            font-weight: 600;
            line-height: 1.2;
            letter-spacing: -0.01em;
        }

        .brand-meta {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 2px;
        }

        .brand-sub {
            font-size: 0.72rem;
            color: var(--text-faint);
        }

        .count-pill {
            font-family: 'DM Mono', monospace;
            font-size: 0.68rem;
            color: var(--accent);
            background: var(--accent-dim);
            border: 1px solid rgba(139,92,246,0.25);
            padding: 1px 7px;
            border-radius: 9999px;
        }

        [data-theme="light"] .count-pill {
            border-color: rgba(124,58,237,0.2);
        }

        .header-right {
            display: flex;
            gap: 6px;
            align-items: center;
        }

        /* ============================================
           STATS GRID
        ============================================ */
        .stats-dashboard {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 10px;
            margin-bottom: 14px;
        }

        @media (max-width: 900px) { .stats-dashboard { grid-template-columns: repeat(3, 1fr); } }
        @media (max-width: 500px) { .stats-dashboard { grid-template-columns: repeat(2, 1fr); } }

        .stat-card {
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 14px 14px 12px;
            border-left: 3px solid var(--dot-color, var(--accent));
            transition: box-shadow 0.18s;
        }

        .stat-card:hover {
            box-shadow: 0 0 0 1px var(--dot-color, var(--accent)), 0 4px 16px rgba(0,0,0,0.3);
        }

        .stat-header {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 8px;
        }

        .stat-dot {
            width: 7px;
            height: 7px;
            border-radius: 50%;
            background: var(--dot-color, var(--accent));
            flex-shrink: 0;
        }

        .stat-label {
            font-size: 0.7rem;
            font-weight: 500;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            line-height: 1;
            color: var(--dot-color, var(--accent));
            margin-bottom: 10px;
        }

        .stat-bar {
            height: 3px;
            background: var(--border);
            border-radius: 2px;
            overflow: hidden;
        }

        .stat-bar-fill {
            height: 100%;
            background: var(--dot-color, var(--accent));
            border-radius: 2px;
            opacity: 0.6;
            transition: width 0.4s ease;
        }

        /* ============================================
           BRAND CHART
        ============================================ */
        .chart-section {
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 16px 18px;
            margin-bottom: 14px;
        }

        .chart-section-title {
            font-size: 0.72rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-muted);
            margin-bottom: 14px;
        }

        .chart-bars {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .chart-row {
            display: grid;
            grid-template-columns: 80px 1fr 32px;
            align-items: center;
            gap: 10px;
        }

        .chart-brand-label {
            font-size: 0.78rem;
            font-weight: 500;
            color: var(--text-muted);
            text-align: right;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chart-track {
            height: 8px;
            background: var(--bg-hover);
            border-radius: 4px;
            overflow: hidden;
            display: flex;
        }

        .chart-segment {
            height: 100%;
            transition: width 0.4s ease;
        }

        .chart-segment:first-child { border-radius: 4px 0 0 4px; }
        .chart-segment:last-child  { border-radius: 0 4px 4px 0; }
        .chart-segment:only-child  { border-radius: 4px; }

        .chart-count {
            font-family: 'DM Mono', monospace;
            font-size: 0.72rem;
            color: var(--text-faint);
            text-align: right;
        }

        /* ============================================
           BARRA DE CONTROLES
        ============================================ */
        .controls-bar {
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 10px 12px;
            margin-bottom: 14px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
        }

        /* ============================================
           INPUTS, SELECTS, BOTONES
        ============================================ */
        input, select, .btn {
            background: var(--bg-body);
            border: 1px solid var(--border);
            color: var(--text-main);
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 0.82rem;
            font-family: 'DM Sans', sans-serif;
            outline: none;
            transition: border-color 0.15s, box-shadow 0.15s;
        }

        select {
            -webkit-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6' viewBox='0 0 10 6'%3E%3Cpath d='M1 1l4 4 4-4' stroke='%2371717a' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 8px center;
            padding-right: 24px;
        }

        input:focus, select:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 2px var(--accent-dim);
        }

        .search-box {
            flex: 1;
            min-width: 180px;
            padding-left: 30px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='13' height='13' viewBox='0 0 24 24' fill='none' stroke='%2371717a' stroke-width='2' stroke-linecap='round'%3E%3Ccircle cx='11' cy='11' r='8'/%3E%3Cline x1='21' y1='21' x2='16.65' y2='16.65'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: 9px center;
        }

        .btn {
            cursor: pointer;
            font-weight: 500;
        }

        .btn:hover {
            border-color: var(--accent);
            background: var(--accent-dim);
            color: var(--accent);
        }

        .btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: #fff;
        }

        [data-theme="light"] .btn.active { color: #fff; }

        .icon-btn {
            padding: 6px 7px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .icon-btn svg { width: 15px; height: 15px; }

        .btn-group-actions {
            display: flex;
            gap: 4px;
            padding-right: 8px;
            border-right: 1px solid var(--border);
        }

        .btn-group-views {
            display: flex;
            gap: 4px;
            padding-right: 8px;
            border-right: 1px solid var(--border);
        }

        .btn-group-theme {
            display: flex;
            gap: 4px;
        }

        .controls-filters {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            align-items: center;
        }

        .controls-right {
            display: flex;
            gap: 6px;
            align-items: center;
            margin-left: auto;
            flex-wrap: wrap;
        }

        .group-by-label {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.78rem;
            color: var(--text-muted);
            cursor: pointer;
            user-select: none;
            padding-right: 8px;
            border-right: 1px solid var(--border);
        }

        .group-by-label input[type="checkbox"] {
            width: 13px;
            height: 13px;
            padding: 0;
            cursor: pointer;
            accent-color: var(--accent);
        }

        .group-by-label.hidden { display: none; }

        /* ============================================
           BADGES (pill con dot)
        ============================================ */
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 2px 8px 2px 6px;
            border-radius: 9999px;
            font-size: 0.7rem;
            font-weight: 500;
            letter-spacing: 0.01em;
            white-space: nowrap;
            border: 1px solid;
        }

        .badge::before {
            content: '';
            width: 5px;
            height: 5px;
            border-radius: 50%;
            background: currentColor;
            flex-shrink: 0;
        }

        .st-ok     { background: var(--ok-bg);     color: var(--ok-tx);     border-color: var(--ok-bd);     }
        .st-warn   { background: var(--warn-bg);   color: var(--warn-tx);   border-color: var(--warn-bd);   }
        .st-err    { background: var(--err-bg);    color: var(--err-tx);    border-color: var(--err-bd);    }
        .st-pend   { background: var(--pend-bg);   color: var(--pend-tx);   border-color: var(--pend-bd);   }
        .st-repair { background: var(--repair-bg); color: var(--repair-tx); border-color: var(--repair-bd); }

        /* ============================================
           TABLA
        ============================================ */
        .table-wrapper {
            overflow-x: auto;
            border: 1px solid var(--border);
            border-radius: 10px;
            background: var(--bg-surface);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
            white-space: nowrap;
        }

        thead {
            position: sticky;
            top: 0;
            z-index: 10;
            background: var(--bg-raised);
            border-bottom: 1px solid var(--border);
        }

        th {
            text-align: left;
            padding: 10px 14px;
            font-size: 0.68rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.07em;
            color: var(--text-faint);
            cursor: pointer;
            user-select: none;
            transition: color 0.15s;
        }

        th:hover, th.active { color: var(--accent); }
        th .sort-icon { margin-left: 3px; opacity: 0.35; font-size: 0.6rem; }
        th.active .sort-icon { opacity: 1; }
        th:focus-visible { outline: 2px solid var(--accent); outline-offset: -2px; }

        td {
            padding: 9px 14px;
            border-bottom: 1px solid var(--border-subtle);
            color: var(--text-main);
            font-size: 0.875rem;
        }

        tbody tr:last-child td { border-bottom: none; }

        tbody tr:hover { background: var(--bg-hover); }

        tbody tr.urgent td:first-child  { border-left: 3px solid var(--err-color); }
        tbody tr.has-film td:first-child { border-left: 3px solid var(--warn-color); }

        .col-brand {
            font-size: 0.72rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-faint);
        }

        .col-model { font-weight: 500; }

        .col-serial {
            font-family: 'DM Mono', monospace;
            font-size: 0.78rem;
            color: var(--text-faint);
        }

        .col-notes {
            font-size: 0.82rem;
            color: var(--text-muted);
            white-space: normal;
            min-width: 180px;
            max-width: 380px;
            line-height: 1.4;
        }

        /* ============================================
           VISTA CARDS
        ============================================ */
        .view-table { display: block; }
        .view-cards { display: none; }
        body.cards-mode .view-table { display: none; }
        body.cards-mode .view-cards { display: block; }

        .cards-view {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(min(280px, 100%), 1fr));
            gap: 14px;
        }

        @media (max-width: 640px) { .cards-view { grid-template-columns: 1fr; } }

        .camera-card {
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            transition: transform 0.18s, box-shadow 0.18s;
            position: relative;
        }

        @media (hover: hover) {
            .camera-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 8px 24px rgba(0,0,0,0.4);
            }
        }

        .camera-card.urgent  { border-color: var(--err-bd);  }
        .camera-card.has-film { border-color: var(--warn-bd); }

        .card-status-stripe {
            height: 4px;
            width: 100%;
        }

        .card-body {
            padding: 14px 15px 15px;
        }

        .card-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .card-header { flex: 1; min-width: 0; }

        .card-brand {
            font-size: 0.65rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-faint);
            margin-bottom: 2px;
        }

        .card-model {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-main);
            line-height: 1.25;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .card-serial {
            font-family: 'DM Mono', monospace;
            font-size: 0.7rem;
            color: var(--text-faint);
            margin-top: 3px;
        }

        .card-status-badge {
            flex-shrink: 0;
            margin-left: 10px;
        }

        .card-divider {
            height: 1px;
            background: var(--border-subtle);
            margin: 12px 0;
        }

        .card-info {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .card-info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.82rem;
        }

        .card-info-row > span:first-child {
            font-size: 0.7rem;
            color: var(--text-faint);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 500;
        }

        .card-notes {
            font-size: 0.8rem;
            color: var(--text-muted);
            line-height: 1.45;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--border-subtle);
        }

        /* ============================================
           GRUPOS POR MARCA
        ============================================ */
        .brand-group { margin-bottom: 16px; }

        .brand-group-header {
            background: var(--bg-raised);
            border: 1px solid var(--border);
            border-radius: 8px 8px 0 0;
            padding: 10px 14px;
            font-weight: 600;
            font-size: 0.9rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
            transition: background 0.15s;
        }

        .brand-group-header:hover { background: var(--bg-hover); }

        .brand-group-count {
            font-family: 'DM Mono', monospace;
            font-size: 0.7rem;
            color: var(--text-faint);
            font-weight: 400;
        }

        .brand-group-content {
            border: 1px solid var(--border);
            border-top: none;
            border-radius: 0 0 8px 8px;
            overflow: hidden;
        }

        .brand-group.collapsed .brand-group-content { display: none; }
        .brand-group-content thead { background: var(--bg-raised); }

        /* ============================================
           EMPTY STATE
        ============================================ */
        .empty-state {
            text-align: center;
            padding: 52px 24px;
            color: var(--text-faint);
            font-size: 0.9rem;
        }

        /* ============================================
           RESPONSIVE
        ============================================ */
        @media (max-width: 768px) {
            .controls-bar { flex-direction: column; align-items: stretch; }
            .controls-right { margin-left: 0; }
            .search-box { min-width: 100%; }
        }

        /* ============================================
           ANIMACIONES
        ============================================ */
        @media (prefers-reduced-motion: no-preference) {
            tbody tr     { animation: rowIn 0.15s ease-out; }
            .camera-card { animation: cardIn 0.18s ease-out; }
            .chart-segment { animation: barIn 0.4s ease-out; }

            @keyframes rowIn  { from { opacity: 0; transform: translateY(-2px); } to { opacity: 1; transform: none; } }
            @keyframes cardIn { from { opacity: 0; transform: translateY(4px);  } to { opacity: 1; transform: none; } }
            @keyframes barIn  { from { transform: scaleX(0); transform-origin: left; } to { transform: scaleX(1); } }
        }

        /* ============================================
           PRINT
        ============================================ */
        @media print {
            .controls-bar, .stats-dashboard, .chart-section, .app-header { display: none; }
            body { background: white; color: black; }
            .table-wrapper { border: 1px solid #000; }
        }
    </style>
</head>
<body>

<div class="container">

    <!-- Cabecera -->
    <header class="app-header">
        <div class="app-brand">
            <div class="brand-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
                    <circle cx="12" cy="13" r="4"/>
                </svg>
            </div>
            <div class="brand-text">
                <h1>C√°maras Anal√≥gicas</h1>
                <div class="brand-meta">
                    <span class="brand-sub">Colecci√≥n personal</span>
                    <span class="count-pill" id="countDisplay" role="status" aria-live="polite">0</span>
                </div>
            </div>
        </div>
        <div class="header-right">
            <a href="index.html" class="btn" style="text-decoration:none;font-size:0.78rem;" title="Ver dise√±o original">‚Üê v1</a>
            <button type="button" id="themeBtn" class="btn icon-btn" aria-label="Cambiar tema" title="Cambiar tema">
                <svg class="theme-icon-dark" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                </svg>
                <svg class="theme-icon-light" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:none">
                    <circle cx="12" cy="12" r="5"/>
                    <line x1="12" y1="1" x2="12" y2="3"/>
                    <line x1="12" y1="21" x2="12" y2="23"/>
                    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
                    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
                    <line x1="1" y1="12" x2="3" y2="12"/>
                    <line x1="21" y1="12" x2="23" y2="12"/>
                    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
                    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
                </svg>
            </button>
        </div>
    </header>

    <!-- Stats -->
    <div class="stats-dashboard" id="statsDashboard"></div>

    <!-- Gr√°fica por marca -->
    <div class="chart-section" id="brandChart"></div>

    <!-- Controles -->
    <div class="controls-bar header-controls">
        <input type="search" id="searchInput" class="search-box" placeholder="Buscar modelo, marca, notas‚Ä¶" aria-label="Buscar c√°maras">

        <div class="controls-filters">
            <select id="brandFilter" aria-label="Filtrar por marca">
                <option value="all">Todas las marcas</option>
            </select>
            <select id="statusFilter" aria-label="Filtrar por estado">
                <option value="all">Todos los estados</option>
                <option value="ok">Funcional</option>
                <option value="warning">Detalles</option>
                <option value="error">Reparar</option>
                <option value="repair">En reparaci√≥n</option>
                <option value="pending">Pendiente</option>
            </select>
            <select id="speedsFilter" aria-label="Filtrar por velocidades">
                <option value="all">Velocidades</option>
                <option value="ok">Correctas</option>
                <option value="bad">Fallan</option>
                <option value="unknown">N/D</option>
            </select>
            <select id="filmFilter" aria-label="Filtrar por carrete">
                <option value="all">Carrete</option>
                <option value="yes">Probado</option>
                <option value="no">No probado</option>
            </select>
        </div>

        <div class="controls-right">
            <div class="btn-group-actions">
                <button type="button" id="resetBtn" class="btn icon-btn" aria-label="Resetear filtros" title="Resetear filtros">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/>
                        <path d="M21 3v5h-5"/>
                        <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/>
                        <path d="M3 21v-5h5"/>
                    </svg>
                </button>
                <button type="button" id="exportBtn" class="btn icon-btn" aria-label="Exportar CSV" title="Exportar CSV">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="7 10 12 15 17 10"/>
                        <line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                </button>
                <button type="button" id="printBtn" class="btn icon-btn" aria-label="Imprimir" title="Imprimir">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="6 9 6 2 18 2 18 9"/>
                        <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/>
                        <rect x="6" y="14" width="12" height="8"/>
                    </svg>
                </button>
            </div>

            <div class="btn-group-views">
                <button type="button" id="tableViewBtn" class="btn icon-btn active" aria-label="Vista tabla" title="Vista tabla">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                        <line x1="3" y1="9" x2="21" y2="9"/>
                        <line x1="9" y1="21" x2="9" y2="9"/>
                    </svg>
                </button>
                <button type="button" id="cardsViewBtn" class="btn icon-btn" aria-label="Vista tarjetas" title="Vista tarjetas">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="3" width="7" height="7"/>
                        <rect x="14" y="3" width="7" height="7"/>
                        <rect x="14" y="14" width="7" height="7"/>
                        <rect x="3" y="14" width="7" height="7"/>
                    </svg>
                </button>
            </div>

            <label class="group-by-label" id="groupByLabel">
                <input type="checkbox" id="groupByBrand"> Agrupar
            </label>
        </div>
    </div>

    <!-- Vista Tabla -->
    <div class="view-table">
        <div class="table-wrapper" id="tableContainer">
            <table role="grid" aria-label="Colecci√≥n de c√°maras anal√≥gicas">
                <thead>
                    <tr>
                        <th data-col="brand"  tabindex="0" role="columnheader" aria-sort="ascending">Marca <span class="sort-icon" aria-hidden="true">‚áÖ</span></th>
                        <th data-col="model"  tabindex="0" role="columnheader">Modelo <span class="sort-icon" aria-hidden="true">‚áÖ</span></th>
                        <th data-col="serial" tabindex="0" role="columnheader">N¬∫ Serie <span class="sort-icon" aria-hidden="true">‚áÖ</span></th>
                        <th data-col="status" tabindex="0" role="columnheader">Estado <span class="sort-icon" aria-hidden="true">‚áÖ</span></th>
                        <th data-col="speeds" tabindex="0" role="columnheader">Velocidades <span class="sort-icon" aria-hidden="true">‚áÖ</span></th>
                        <th data-col="film"   tabindex="0" role="columnheader">Carrete <span class="sort-icon" aria-hidden="true">‚áÖ</span></th>
                        <th data-col="loaded" tabindex="0" role="columnheader">Con Carrete <span class="sort-icon" aria-hidden="true">‚áÖ</span></th>
                        <th data-col="notes"  tabindex="0" role="columnheader">Observaciones <span class="sort-icon" aria-hidden="true">‚áÖ</span></th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

    <!-- Vista Cards -->
    <div class="view-cards">
        <div class="cards-view" id="cardsContainer"></div>
    </div>

</div>

<script>
(function () {
    'use strict';

    let CAMERAS = [];

    const CONFIG = Object.freeze({
        status: {
            ok:      { label: 'Funcional',     cssClass: 'st-ok',     color: '#22c55e' },
            warning: { label: 'Detalles',      cssClass: 'st-warn',   color: '#f59e0b' },
            error:   { label: 'Reparar',       cssClass: 'st-err',    color: '#ef4444' },
            repair:  { label: 'En reparaci√≥n', cssClass: 'st-repair', color: '#f97316' },
            pending: { label: 'Por Revelar',   cssClass: 'st-pend',   color: '#a855f7' }
        },
        speeds: {
            ok:      { label: 'Correctas', cssClass: 'st-ok' },
            bad:     { label: 'Fallan',    cssClass: 'st-err' },
            unknown: { label: 'N/D',       cssClass: 'st-pend' }
        },
        film: {
            yes: { label: 'Probado',    cssClass: 'st-ok' },
            no:  { label: 'No probado', cssClass: 'st-pend' }
        },
        loaded: {
            yes: { label: 'S√≠', cssClass: 'st-warn' },
            no:  { label: 'No', cssClass: 'st-pend' }
        },
        defaults:   { speeds: 'unknown', film: 'no', loaded: 'no' },
        storageKey: 'cameraCollection.v3'
    });

    // ============================================
    // UTILIDADES
    // ============================================
    const collator = new Intl.Collator('es', { sensitivity: 'base', numeric: true });

    const Utils = {
        compareText: (a, b) => collator.compare(String(a ?? ''), String(b ?? '')),
        normalize:   (v)    => String(v ?? '').toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu, '').trim(),
        debounce(fn, delay = 150) {
            let t;
            return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), delay); };
        },
        parseSerial(s) {
            const v = String(s ?? '').trim();
            if (!v || v === '-') return null;
            const n = parseInt(v, 10);
            return Number.isFinite(n) ? n : null;
        },
        buildSearchIndex(cam) {
            const st = CONFIG.status[cam.status] ?? {};
            const sp = CONFIG.speeds[cam.speeds ?? CONFIG.defaults.speeds] ?? {};
            const fm = CONFIG.film[cam.film ?? CONFIG.defaults.film] ?? {};
            const ld = CONFIG.loaded[cam.loaded ?? CONFIG.defaults.loaded] ?? {};
            return Utils.normalize([cam.brand, cam.model, cam.serial, cam.notes,
                cam.status, st.label, cam.speeds, sp.label, cam.film, fm.label, cam.loaded, ld.label].join(' '));
        }
    };

    let searchIndexes = new Map();

    // ============================================
    // DOM
    // ============================================
    const $ = (s) => document.querySelector(s);
    const $$ = (s) => document.querySelectorAll(s);

    const DOM = {
        tableBody:      $('#tableBody'),
        cardsContainer: $('#cardsContainer'),
        tableContainer: $('#tableContainer'),
        statsDashboard: $('#statsDashboard'),
        brandChart:     $('#brandChart'),
        searchInput:    $('#searchInput'),
        brandFilter:    $('#brandFilter'),
        statusFilter:   $('#statusFilter'),
        speedsFilter:   $('#speedsFilter'),
        filmFilter:     $('#filmFilter'),
        resetBtn:       $('#resetBtn'),
        exportBtn:      $('#exportBtn'),
        printBtn:       $('#printBtn'),
        themeBtn:       $('#themeBtn'),
        tableViewBtn:   $('#tableViewBtn'),
        cardsViewBtn:   $('#cardsViewBtn'),
        groupByBrand:   $('#groupByBrand'),
        groupByLabel:   $('#groupByLabel'),
        countDisplay:   $('#countDisplay'),
        headers:        $$('th[data-col]')
    };

    const state = {
        sort:         { column: 'brand', direction: 'asc' },
        view:         'table',
        theme:        'dark',
        groupByBrand: false
    };

    // ============================================
    // FILTRADO & ORDENACI√ìN
    // ============================================
    const getFilters = () => ({
        search: Utils.normalize(DOM.searchInput.value),
        brand:  DOM.brandFilter.value,
        status: DOM.statusFilter.value,
        speeds: DOM.speedsFilter.value,
        film:   DOM.filmFilter.value
    });

    const filterCameras = (cameras, filters) => {
        const { search, brand, status, speeds, film } = filters;
        return cameras.filter(cam => {
            if (search && !searchIndexes.get(cam).includes(search)) return false;
            if (brand  !== 'all' && cam.brand  !== brand)  return false;
            if (status !== 'all' && cam.status !== status) return false;
            if (speeds !== 'all' && (cam.speeds ?? CONFIG.defaults.speeds) !== speeds) return false;
            if (film   !== 'all' && (cam.film   ?? CONFIG.defaults.film)   !== film)   return false;
            return true;
        });
    };

    const sortCameras = (cameras, { column, direction }) => {
        const dir = direction === 'asc' ? 1 : -1;
        const cmp = {
            serial:  (a, b) => { const nA = Utils.parseSerial(a.serial), nB = Utils.parseSerial(b.serial); if (nA === null && nB === null) return 0; if (nA === null) return 1; if (nB === null) return -1; return nA - nB; },
            status:  (a, b) => Utils.compareText(CONFIG.status[a.status]?.label ?? '', CONFIG.status[b.status]?.label ?? ''),
            speeds:  (a, b) => Utils.compareText(CONFIG.speeds[a.speeds ?? CONFIG.defaults.speeds]?.label ?? '', CONFIG.speeds[b.speeds ?? CONFIG.defaults.speeds]?.label ?? ''),
            film:    (a, b) => Utils.compareText(CONFIG.film[a.film ?? CONFIG.defaults.film]?.label ?? '', CONFIG.film[b.film ?? CONFIG.defaults.film]?.label ?? ''),
            loaded:  (a, b) => Utils.compareText(CONFIG.loaded[a.loaded ?? CONFIG.defaults.loaded]?.label ?? '', CONFIG.loaded[b.loaded ?? CONFIG.defaults.loaded]?.label ?? ''),
            default: (a, b) => Utils.compareText(a[column] ?? '', b[column] ?? '')
        };
        const compare = cmp[column] ?? cmp.default;
        return [...cameras].sort((a, b) => {
            const r = compare(a, b);
            return r !== 0 ? r * dir : Utils.compareText(`${a.brand} ${a.model} ${a.serial}`, `${b.brand} ${b.model} ${b.serial}`);
        });
    };

    // ============================================
    // RENDERIZADO
    // ============================================
    const createBadge = (text, cssClass) => {
        const s = document.createElement('span');
        s.className = `badge ${cssClass}`;
        s.textContent = text;
        return s;
    };

    const createCell = (text, cls) => {
        const td = document.createElement('td');
        if (cls) td.className = cls;
        td.textContent = text;
        return td;
    };

    const createRow = (cam) => {
        const tr = document.createElement('tr');
        const st = CONFIG.status[cam.status];
        const sp = CONFIG.speeds[cam.speeds ?? CONFIG.defaults.speeds];
        const fm = CONFIG.film[cam.film ?? CONFIG.defaults.film];
        const ld = CONFIG.loaded[cam.loaded ?? CONFIG.defaults.loaded];

        if (cam.status === 'error') tr.classList.add('urgent');
        if (cam.loaded === 'yes')   tr.classList.add('has-film');

        tr.appendChild(createCell(cam.brand,  'col-brand'));
        tr.appendChild(createCell(cam.model,  'col-model'));
        tr.appendChild(createCell(cam.serial, 'col-serial'));

        [st, sp, fm, ld].forEach(cfg => {
            const td = document.createElement('td');
            td.appendChild(createBadge(cfg.label, cfg.cssClass));
            tr.appendChild(td);
        });

        tr.appendChild(createCell(cam.notes, 'col-notes'));
        return tr;
    };

    const createCard = (cam) => {
        const card = document.createElement('div');
        card.className = 'camera-card';

        const st = CONFIG.status[cam.status];
        const sp = CONFIG.speeds[cam.speeds ?? CONFIG.defaults.speeds];
        const fm = CONFIG.film[cam.film ?? CONFIG.defaults.film];
        const ld = CONFIG.loaded[cam.loaded ?? CONFIG.defaults.loaded];

        if (cam.status === 'error') card.classList.add('urgent');
        if (cam.loaded === 'yes')   card.classList.add('has-film');

        // Franja de color de estado
        const stripe = document.createElement('div');
        stripe.className = 'card-status-stripe';
        stripe.style.background = st.color ?? '#8b5cf6';

        // Cuerpo
        const body = document.createElement('div');
        body.className = 'card-body';

        // Top: header + status badge
        const top = document.createElement('div');
        top.className = 'card-top';

        const header = document.createElement('div');
        header.className = 'card-header';

        const brandEl = document.createElement('div');
        brandEl.className = 'card-brand';
        brandEl.textContent = cam.brand;

        const modelEl = document.createElement('div');
        modelEl.className = 'card-model';
        modelEl.textContent = cam.model;

        const serialEl = document.createElement('div');
        serialEl.className = 'card-serial';
        serialEl.textContent = `S/N ${cam.serial}`;

        header.appendChild(brandEl);
        header.appendChild(modelEl);
        header.appendChild(serialEl);

        const statusBadge = document.createElement('div');
        statusBadge.className = 'card-status-badge';
        statusBadge.appendChild(createBadge(st.label, st.cssClass));

        top.appendChild(header);
        top.appendChild(statusBadge);

        // Info rows
        const divider = document.createElement('div');
        divider.className = 'card-divider';

        const info = document.createElement('div');
        info.className = 'card-info';

        const makeRow = (label, badge) => {
            const row = document.createElement('div');
            row.className = 'card-info-row';
            const lbl = document.createElement('span');
            lbl.textContent = label;
            row.appendChild(lbl);
            row.appendChild(badge);
            return row;
        };

        info.appendChild(makeRow('Velocidades:', createBadge(sp.label, sp.cssClass)));
        info.appendChild(makeRow('Carrete:',     createBadge(fm.label, fm.cssClass)));
        info.appendChild(makeRow('Cargada:',     createBadge(ld.label, ld.cssClass)));

        // Notas
        const notes = document.createElement('div');
        notes.className = 'card-notes';
        notes.textContent = cam.notes || 'Sin observaciones';

        body.appendChild(top);
        body.appendChild(divider);
        body.appendChild(info);
        body.appendChild(notes);

        card.appendChild(stripe);
        card.appendChild(body);
        return card;
    };

    // ---- Stats ----
    const renderStats = (cameras) => {
        const total = cameras.length;
        const stats = [
            { label: 'Total',        value: total,                                             color: '#8b5cf6',                      pct: 100 },
            { label: 'Funcionales',  value: cameras.filter(c => c.status === 'ok').length,     color: '#22c55e', pct: 0 },
            { label: 'Detalles',     value: cameras.filter(c => c.status === 'warning').length,color: '#f59e0b', pct: 0 },
            { label: 'A reparar',    value: cameras.filter(c => c.status === 'error').length,  color: '#ef4444', pct: 0 },
            { label: 'En taller',    value: cameras.filter(c => c.status === 'repair').length, color: '#f97316', pct: 0 },
            { label: 'Cargadas',     value: cameras.filter(c => c.loaded === 'yes').length,    color: '#06b6d4', pct: 0 }
        ];
        stats.forEach(s => { if (s.pct === 0) s.pct = total ? Math.round(s.value / total * 100) : 0; });

        const dashboard = DOM.statsDashboard;
        dashboard.innerHTML = '';
        const frag = document.createDocumentFragment();

        stats.forEach(({ label, value, color, pct }) => {
            const card = document.createElement('div');
            card.className = 'stat-card';
            card.style.setProperty('--dot-color', color);

            const hdr = document.createElement('div');
            hdr.className = 'stat-header';
            const dot = document.createElement('span');
            dot.className = 'stat-dot';
            const lbl = document.createElement('span');
            lbl.className = 'stat-label';
            lbl.textContent = label;
            hdr.appendChild(dot);
            hdr.appendChild(lbl);

            const num = document.createElement('div');
            num.className = 'stat-number';
            num.textContent = value;

            const bar = document.createElement('div');
            bar.className = 'stat-bar';
            const fill = document.createElement('div');
            fill.className = 'stat-bar-fill';
            fill.style.width = `${pct}%`;
            bar.appendChild(fill);

            card.appendChild(hdr);
            card.appendChild(num);
            card.appendChild(bar);
            frag.appendChild(card);
        });

        dashboard.appendChild(frag);
    };

    // ---- Brand chart ----
    const renderBrandChart = () => {
        const el = DOM.brandChart;
        if (!el) return;
        el.innerHTML = '';

        if (CAMERAS.length === 0) return;

        const title = document.createElement('div');
        title.className = 'chart-section-title';
        title.textContent = 'Distribuci√≥n por marca';
        el.appendChild(title);

        const brands = {};
        CAMERAS.forEach(cam => {
            if (!brands[cam.brand]) brands[cam.brand] = { total: 0, ok: 0, warn: 0, err: 0, repair: 0, pend: 0 };
            brands[cam.brand].total++;
            const s = cam.status;
            if (s === 'ok')      brands[cam.brand].ok++;
            else if (s === 'warning') brands[cam.brand].warn++;
            else if (s === 'error')   brands[cam.brand].err++;
            else if (s === 'repair')  brands[cam.brand].repair++;
            else if (s === 'pending') brands[cam.brand].pend++;
        });

        const max = Math.max(...Object.values(brands).map(b => b.total));
        const sorted = Object.entries(brands).sort((a, b) => b[1].total - a[1].total);

        const bars = document.createElement('div');
        bars.className = 'chart-bars';

        sorted.forEach(([brand, data]) => {
            const row = document.createElement('div');
            row.className = 'chart-row';

            const lbl = document.createElement('span');
            lbl.className = 'chart-brand-label';
            lbl.textContent = brand;
            lbl.title = brand;

            const track = document.createElement('div');
            track.className = 'chart-track';

            const segments = [
                { count: data.ok,     color: '#22c55e' },
                { count: data.warn,   color: '#f59e0b' },
                { count: data.err,    color: '#ef4444' },
                { count: data.repair, color: '#f97316' },
                { count: data.pend,   color: '#a855f7' }
            ];

            segments.forEach(({ count, color }) => {
                if (count === 0) return;
                const seg = document.createElement('div');
                seg.className = 'chart-segment';
                seg.style.width = `${(count / max * 100).toFixed(1)}%`;
                seg.style.background = color;
                seg.title = `${count}`;
                track.appendChild(seg);
            });

            const cnt = document.createElement('span');
            cnt.className = 'chart-count';
            cnt.textContent = data.total;

            row.appendChild(lbl);
            row.appendChild(track);
            row.appendChild(cnt);
            bars.appendChild(row);
        });

        el.appendChild(bars);
    };

    // ---- Table ----
    const renderTable = (cameras) => {
        const tbody = DOM.tableBody;
        tbody.innerHTML = '';
        if (cameras.length === 0) {
            const tr = document.createElement('tr');
            const td = document.createElement('td');
            td.colSpan = 8; td.className = 'empty-state';
            td.textContent = 'No se encontraron c√°maras con los filtros seleccionados';
            tr.appendChild(td); tbody.appendChild(tr);
        } else {
            const frag = document.createDocumentFragment();
            cameras.forEach(cam => frag.appendChild(createRow(cam)));
            tbody.appendChild(frag);
        }
        DOM.countDisplay.textContent = cameras.length;
    };

    // ---- Cards ----
    const renderCards = (cameras) => {
        const c = DOM.cardsContainer;
        c.innerHTML = '';
        if (cameras.length === 0) {
            const empty = document.createElement('div');
            empty.className = 'empty-state';
            empty.textContent = 'No se encontraron c√°maras con los filtros seleccionados';
            c.appendChild(empty);
        } else {
            const frag = document.createDocumentFragment();
            cameras.forEach(cam => frag.appendChild(createCard(cam)));
            c.appendChild(frag);
        }
        DOM.countDisplay.textContent = cameras.length;
    };

    // ---- Grouped table ----
    const sortByPriority = (a, b) => {
        const p = { repair: 0, error: 1, warning: 2, pending: 3, ok: 4 };
        const pa = p[a.status] ?? 9, pb = p[b.status] ?? 9;
        if (a.loaded === 'yes' && b.loaded !== 'yes' && pa >= 2) return -1;
        if (a.loaded !== 'yes' && b.loaded === 'yes' && pb >= 2) return 1;
        if (pa !== pb) return pa - pb;
        return Utils.compareText(a.model, b.model);
    };

    const renderGroupedTable = (cameras) => {
        let gc = document.getElementById('groupedTableContainer');
        if (!gc) {
            gc = document.createElement('div');
            gc.id = 'groupedTableContainer';
            DOM.tableContainer.parentNode.appendChild(gc);
        }
        gc.innerHTML = '';

        if (cameras.length === 0) {
            const e = document.createElement('div');
            e.className = 'empty-state';
            e.textContent = 'No se encontraron c√°maras con los filtros seleccionados';
            gc.appendChild(e);
            DOM.countDisplay.textContent = 0;
            return;
        }

        const groups = {};
        cameras.forEach(cam => { if (!groups[cam.brand]) groups[cam.brand] = []; groups[cam.brand].push(cam); });

        const frag = document.createDocumentFragment();
        Object.keys(groups).sort(Utils.compareText).forEach(brand => {
            const brandCams = groups[brand].sort(sortByPriority);
            const group = document.createElement('div');
            group.className = 'brand-group';

            const hdr = document.createElement('div');
            hdr.className = 'brand-group-header';
            const t = document.createElement('span'); t.textContent = brand;
            const ct = document.createElement('span'); ct.className = 'brand-group-count'; ct.textContent = `${brandCams.length} c√°mara${brandCams.length > 1 ? 's' : ''}`;
            hdr.appendChild(t); hdr.appendChild(ct);
            hdr.addEventListener('click', () => group.classList.toggle('collapsed'));

            const content = document.createElement('div');
            content.className = 'brand-group-content';

            const table = document.createElement('table');
            table.innerHTML = `<thead><tr><th>Modelo</th><th>N¬∫ Serie</th><th>Estado</th><th>Velocidades</th><th>Carrete</th><th>Con Carrete</th><th>Observaciones</th></tr></thead>`;
            const tbody = document.createElement('tbody');

            brandCams.forEach(cam => {
                const tr = document.createElement('tr');
                if (cam.status === 'error') tr.classList.add('urgent');
                if (cam.loaded === 'yes')   tr.classList.add('has-film');
                const st = CONFIG.status[cam.status];
                const sp = CONFIG.speeds[cam.speeds ?? CONFIG.defaults.speeds];
                const fm = CONFIG.film[cam.film ?? CONFIG.defaults.film];
                const ld = CONFIG.loaded[cam.loaded ?? CONFIG.defaults.loaded];
                tr.appendChild(createCell(cam.model,  'col-model'));
                tr.appendChild(createCell(cam.serial, 'col-serial'));
                [st, sp, fm, ld].forEach(cfg => { const td = document.createElement('td'); td.appendChild(createBadge(cfg.label, cfg.cssClass)); tr.appendChild(td); });
                tr.appendChild(createCell(cam.notes, 'col-notes'));
                tbody.appendChild(tr);
            });

            table.appendChild(tbody);
            content.appendChild(table);
            group.appendChild(hdr);
            group.appendChild(content);
            frag.appendChild(group);
        });

        gc.appendChild(frag);
        DOM.countDisplay.textContent = cameras.length;
    };

    const updateHeaderIcons = () => {
        DOM.headers.forEach(th => {
            const col = th.dataset.col;
            const active = col === state.sort.column;
            const icon = th.querySelector('.sort-icon');
            th.classList.toggle('active', active);
            th.setAttribute('aria-sort', active ? (state.sort.direction === 'asc' ? 'ascending' : 'descending') : 'none');
            icon.textContent = active ? (state.sort.direction === 'asc' ? '‚Üë' : '‚Üì') : '‚áÖ';
        });
    };

    const render = () => {
        const filters  = getFilters();
        const filtered = filterCameras(CAMERAS, filters);
        const sorted   = sortCameras(filtered, state.sort);
        renderStats(CAMERAS);

        const gc = document.getElementById('groupedTableContainer');
        if (state.groupByBrand && state.view === 'table') {
            DOM.tableContainer.style.display = 'none';
            if (gc) gc.style.display = '';
            renderGroupedTable(sorted);
        } else if (state.view === 'table') {
            if (gc) gc.style.display = 'none';
            DOM.tableContainer.style.display = '';
            renderTable(sorted);
        } else {
            if (gc) gc.style.display = 'none';
            DOM.tableContainer.style.display = 'none';
            renderCards(sorted);
        }
        updateHeaderIcons();
    };

    const scheduleRender = Utils.debounce(render, 150);

    // ============================================
    // PERSISTENCIA
    // ============================================
    const Storage = {
        save() {
            try {
                localStorage.setItem(CONFIG.storageKey, JSON.stringify({
                    sort: state.sort, view: state.view, theme: state.theme,
                    groupByBrand: state.groupByBrand,
                    filters: { search: DOM.searchInput.value, brand: DOM.brandFilter.value,
                               status: DOM.statusFilter.value, speeds: DOM.speedsFilter.value, film: DOM.filmFilter.value }
                }));
            } catch {}
        },
        load() {
            try {
                const d = JSON.parse(localStorage.getItem(CONFIG.storageKey));
                if (!d) return;
                if (d.sort?.column)            state.sort        = d.sort;
                if (d.view)                    state.view        = d.view;
                if (d.theme)                   state.theme       = d.theme;
                if (d.groupByBrand !== undefined) state.groupByBrand = d.groupByBrand;
                if (d.filters) {
                    DOM.searchInput.value  = d.filters.search ?? '';
                    DOM.brandFilter.value  = d.filters.brand  ?? 'all';
                    DOM.statusFilter.value = d.filters.status ?? 'all';
                    DOM.speedsFilter.value = d.filters.speeds ?? 'all';
                    DOM.filmFilter.value   = d.filters.film   ?? 'all';
                }
            } catch {}
        }
    };

    // ============================================
    // CARGA DE DATOS
    // ============================================
    const loadCameras = async () => {
        try {
            const res = await fetch('cameras.json');
            if (!res.ok) throw new Error();
            const data = await res.json();
            CAMERAS = Object.freeze(data);
            searchIndexes = new Map(CAMERAS.map(cam => [cam, Utils.buildSearchIndex(cam)]));
            return true;
        } catch {
            DOM.tableBody.innerHTML = `<tr><td colspan="8" class="empty-state">Error al cargar los datos. Recarga la p√°gina.</td></tr>`;
            return false;
        }
    };

    // ============================================
    // INICIALIZACI√ìN
    // ============================================
    const populateBrandFilter = () => {
        const brands = [...new Set(CAMERAS.map(c => c.brand))].sort(Utils.compareText);
        const frag = document.createDocumentFragment();
        const all = document.createElement('option'); all.value = 'all'; all.textContent = 'Todas las marcas'; frag.appendChild(all);
        brands.forEach(b => { const o = document.createElement('option'); o.value = b; o.textContent = b; frag.appendChild(o); });
        DOM.brandFilter.innerHTML = '';
        DOM.brandFilter.appendChild(frag);
    };

    const applyTheme = () => {
        document.documentElement.setAttribute('data-theme', state.theme);
        const di = DOM.themeBtn.querySelector('.theme-icon-dark');
        const li = DOM.themeBtn.querySelector('.theme-icon-light');
        di.style.display = state.theme === 'dark' ? '' : 'none';
        li.style.display = state.theme === 'dark' ? 'none' : '';
    };

    const resetFilters = () => {
        DOM.searchInput.value = ''; DOM.brandFilter.value = 'all';
        DOM.statusFilter.value = 'all'; DOM.speedsFilter.value = 'all'; DOM.filmFilter.value = 'all';
        state.sort = { column: 'brand', direction: 'asc' };
        Storage.save(); render(); DOM.searchInput.focus();
    };

    const toggleView = (view) => {
        state.view = view;
        document.body.classList.toggle('cards-mode', view === 'cards');
        DOM.tableViewBtn.classList.toggle('active', view === 'table');
        DOM.cardsViewBtn.classList.toggle('active', view === 'cards');
        DOM.groupByLabel.classList.toggle('hidden', view === 'cards');
        Storage.save(); render();
    };

    const exportToCSV = () => {
        const sorted = sortCameras(filterCameras(CAMERAS, getFilters()), state.sort);
        const hdrs = ['Marca','Modelo','N¬∫ Serie','Estado','Velocidades','Carrete','Con Carrete','Observaciones'];
        const rows = sorted.map(cam => [
            cam.brand, cam.model, cam.serial,
            CONFIG.status[cam.status]?.label ?? '',
            CONFIG.speeds[cam.speeds ?? CONFIG.defaults.speeds]?.label ?? '',
            CONFIG.film[cam.film ?? CONFIG.defaults.film]?.label ?? '',
            CONFIG.loaded[cam.loaded ?? CONFIG.defaults.loaded]?.label ?? '',
            cam.notes
        ].map(c => `"${String(c).replace(/"/g,'""')}"`).join(','));
        const blob = new Blob(['\ufeff' + [hdrs.join(','), ...rows].join('\n')], { type: 'text/csv;charset=utf-8;' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `camaras_${new Date().toISOString().split('T')[0]}.csv`;
        a.click(); URL.revokeObjectURL(a.href);
    };

    const init = async () => {
        DOM.tableBody.innerHTML = `<tr><td colspan="8" class="empty-state">Cargando datos‚Ä¶</td></tr>`;
        if (!(await loadCameras())) return;

        populateBrandFilter();
        Storage.load();
        applyTheme();

        document.body.classList.toggle('cards-mode', state.view === 'cards');
        DOM.tableViewBtn.classList.toggle('active', state.view === 'table');
        DOM.cardsViewBtn.classList.toggle('active', state.view === 'cards');
        DOM.groupByLabel.classList.toggle('hidden', state.view === 'cards');
        DOM.groupByBrand.checked = state.groupByBrand;

        renderBrandChart();

        DOM.searchInput.addEventListener('input',  () => { Storage.save(); scheduleRender(); });
        [DOM.brandFilter, DOM.statusFilter, DOM.speedsFilter, DOM.filmFilter].forEach(el =>
            el.addEventListener('change', () => { Storage.save(); render(); })
        );
        DOM.resetBtn.addEventListener('click',      resetFilters);
        DOM.exportBtn.addEventListener('click',     exportToCSV);
        DOM.printBtn.addEventListener('click',      () => window.print());
        DOM.themeBtn.addEventListener('click',      () => { state.theme = state.theme === 'dark' ? 'light' : 'dark'; applyTheme(); Storage.save(); });
        DOM.tableViewBtn.addEventListener('click',  () => toggleView('table'));
        DOM.cardsViewBtn.addEventListener('click',  () => toggleView('cards'));
        DOM.groupByBrand.addEventListener('change', () => { state.groupByBrand = DOM.groupByBrand.checked; Storage.save(); render(); });

        const thead = document.querySelector('thead');
        thead.addEventListener('click', e => { const th = e.target.closest('th[data-col]'); if (th) { state.sort.column === th.dataset.col ? (state.sort.direction = state.sort.direction === 'asc' ? 'desc' : 'asc') : (state.sort.column = th.dataset.col, state.sort.direction = 'asc'); Storage.save(); render(); } });
        thead.addEventListener('keydown', e => { const th = e.target.closest('th[data-col]'); if (th && (e.key === 'Enter' || e.key === ' ')) { e.preventDefault(); th.click(); } });

        render();
    };

    document.readyState === 'loading' ? document.addEventListener('DOMContentLoaded', init) : init();
})();
</script>
</body>
</html>
