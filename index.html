<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C√°maras anal√≥gicas</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-body: #111111;
            --bg-surface: #1c1c1c;
            --bg-hover: #2a2a2a;
            --border: #333;
            --text-main: #e5e5e5;
            --text-muted: #888;
            --accent: #3b82f6;
            
            --ok-bg: rgba(16, 185, 129, 0.15); --ok-tx: #6ee7b7;
            --warn-bg: rgba(245, 158, 11, 0.15); --warn-tx: #fcd34d;
            --err-bg: rgba(239, 68, 68, 0.15); --err-tx: #fca5a5;
            --pend-bg: rgba(139, 92, 246, 0.15); --pend-tx: #c4b5fd;
        }

        [data-theme="light"] {
            --bg-body: #e8e9ea;
            --bg-surface: #f0f1f2;
            --bg-hover: #dcdee0;
            --border: #c5c7ca;
            --text-main: #2c2d2e;
            --text-muted: #5a5c5e;
            --accent: #0d6efd;
            
            --ok-bg: rgba(16, 185, 129, 0.15); --ok-tx: #0a6640;
            --warn-bg: rgba(245, 158, 11, 0.15); --warn-tx: #a04700;
            --err-bg: rgba(220, 38, 38, 0.15); --err-tx: #a31515;
            --pend-bg: rgba(139, 92, 246, 0.15); --pend-tx: #5a1fa1;
        }

        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            padding: clamp(12px, 3vw, 20px);
            font-size: 14px;
            line-height: 1.5;
        }

        .container { max-width: 1400px; margin: 0 auto; }

        /* Dashboard Stats */
        .stats-dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
            text-align: center;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Header y Filtros */
        .header-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: var(--bg-surface);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--border);
            align-items: center;
            flex-wrap: wrap;
        }

        h1 { 
            margin-right: auto; 
            font-size: clamp(1rem, 2.5vw, 1.2rem); 
            font-weight: 600; 
            letter-spacing: -0.5px; 
        }

        input, select, .btn {
            background: var(--bg-body);
            border: 1px solid var(--border);
            color: var(--text-main);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.9rem;
            font-family: inherit;
            outline: none;
            transition: border-color 0.2s, background-color 0.2s;
        }
        
        input:focus, select:focus, .btn:focus { 
            border-color: var(--accent); 
            outline: 2px solid transparent;
        }
        
        .search-box { min-width: min(250px, 100%); }

        .btn { cursor: pointer; }
        .btn:hover { background: var(--bg-hover); }

        .btn-group {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .icon-btn {
            padding: 8px;
            min-width: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
        }

        .view-toggle {
            display: flex;
            border-radius: 6px;
            overflow: hidden;
        }

        .view-toggle button {
            border-radius: 0;
            border-right: 1px solid var(--border);
        }

        .view-toggle button:last-child {
            border-right: none;
        }

        .view-toggle button.active {
            background: var(--accent);
            color: white;
        }

        /* Tabla */
        .table-wrapper {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--bg-surface);
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.3);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            white-space: nowrap; 
        }

        thead {
            background: #252525;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        [data-theme="light"] thead {
            background: #e9ecef;
        }

        [data-theme="light"] .brand-group-content thead {
            background: #e9ecef;
        }

        th {
            text-align: left;
            padding: 12px 16px;
            font-size: 0.8rem;
            text-transform: uppercase;
            color: var(--text-muted);
            font-weight: 600;
            cursor: pointer;
            user-select: none;
            transition: color 0.2s, background-color 0.2s;
            border-bottom: 1px solid var(--border);
        }

        th:hover, th:focus-visible { color: var(--text-main); background: #333; }
        [data-theme="light"] th:hover, [data-theme="light"] th:focus-visible { background: #dee2e6; }
        th:focus-visible { outline: 2px solid var(--accent); outline-offset: -2px; }
        
        th .sort-icon { margin-left: 5px; opacity: 0.3; font-size: 10px; }
        th.active { color: var(--accent); }
        th.active .sort-icon { opacity: 1; }

        td {
            padding: 10px 16px;
            border-bottom: 1px solid var(--border);
            color: #d4d4d4;
        }

        tbody tr:last-child td { border-bottom: none; }
        tbody tr:hover { background-color: var(--bg-hover); }
        
        tbody tr.urgent {
            border-left: 3px solid var(--err-tx);
        }
        
        tbody tr.has-film {
            border-left: 3px solid var(--warn-tx);
        }

        .col-brand { font-weight: 600; color: #fff; }
        [data-theme="light"] .col-brand { color: #212529; }
        .col-model { font-weight: 500; }
        .col-serial { 
            font-family: 'JetBrains Mono', monospace; 
            font-size: 0.85rem; 
            color: var(--text-muted);
        }
        .col-notes { 
            white-space: normal;
            color: #999;
            font-size: 0.9rem;
            line-height: 1.4;
            min-width: 300px;
            max-width: 400px;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            white-space: nowrap;
        }
        .st-ok { background: var(--ok-bg); color: var(--ok-tx); }
        .st-warn { background: var(--warn-bg); color: var(--warn-tx); }
        .st-err { background: var(--err-bg); color: var(--err-tx); }
        .st-pend { background: var(--pend-bg); color: var(--pend-tx); }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
        }

        /* Vista Cards */
        .cards-view {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 16px;
            padding: 20px;
        }

        .camera-card {
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .camera-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .camera-card.urgent {
            border-left: 4px solid var(--err-tx);
        }

        .camera-card.has-film {
            border-left: 4px solid var(--warn-tx);
        }

        .card-header {
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border);
        }

        .card-brand {
            font-size: 0.85rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .card-model {
            font-size: 1.1rem;
            font-weight: 600;
            margin-top: 4px;
        }

        .card-serial {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .card-info {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 12px;
        }

        .card-info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
        }

        .card-notes {
            font-size: 0.85rem;
            color: var(--text-muted);
            line-height: 1.4;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid var(--border);
        }

        .view-table { display: block; }
        .view-cards { display: none; }
        body.cards-mode .view-table { display: none; }
        body.cards-mode .view-cards { display: block; }

        /* Grupos por marca */
        .brand-group {
            margin-bottom: 24px;
        }

        .brand-group-header {
            background: var(--bg-surface);
            padding: 12px 16px;
            border: 1px solid var(--border);
            border-radius: 8px 8px 0 0;
            font-weight: 600;
            font-size: 1.1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
            transition: background 0.2s;
        }

        .brand-group-header:hover {
            background: var(--bg-hover);
        }

        .brand-group-count {
            font-size: 0.9rem;
            color: var(--text-muted);
            font-weight: 400;
        }

        .brand-group-content {
            border: 1px solid var(--border);
            border-top: none;
            border-radius: 0 0 8px 8px;
        }

        .brand-group.collapsed .brand-group-content {
            display: none;
        }

        .brand-group-content table {
            border: none;
        }

        .brand-group-content thead {
            background: #252525;
        }

        /* Animaci√≥n sutil al cargar filas */
        @media (prefers-reduced-motion: no-preference) {
            tbody tr {
                animation: fadeIn 0.2s ease-out;
            }
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(-4px); }
                to { opacity: 1; transform: translateY(0); }
            }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-controls { flex-direction: column; align-items: stretch; }
            h1 { margin-right: 0; margin-bottom: 10px; text-align: center; }
            .search-box { min-width: 100%; }
            .btn-group { justify-content: center; }
            .stats-dashboard { grid-template-columns: repeat(2, 1fr); }
        }

        @media print {
            .header-controls, .stats-dashboard { display: none; }
            body { background: white; color: black; }
            .table-wrapper { border: 1px solid #000; box-shadow: none; }
        }
    </style>
</head>
<body>

<div class="container">
    <!-- Dashboard de Estad√≠sticas -->
    <div class="stats-dashboard" id="statsDashboard"></div>

    <header class="header-controls">
        <h1>üì∑ Colecci√≥n (<span id="countDisplay" role="status" aria-live="polite">0</span>)</h1>
        
        <input type="search" id="searchInput" class="search-box" placeholder="Buscar..." aria-label="Buscar c√°maras">
        
        <select id="brandFilter" aria-label="Filtrar por marca">
            <option value="all">Todas las Marcas</option>
        </select>

        <select id="statusFilter" aria-label="Filtrar por estado">
            <option value="all">Todos los Estados</option>
            <option value="ok">üü¢ Funcional</option>
            <option value="warning">‚ö†Ô∏è Detalles</option>
            <option value="error">üî¥ Reparar</option>
            <option value="pending">‚è≥ Pendiente</option>
        </select>

        <select id="speedsFilter" aria-label="Filtrar por velocidades">
            <option value="all">Todas las Velocidades</option>
            <option value="ok">‚úÖ Correctas</option>
            <option value="bad">‚ùå Fallan</option>
            <option value="unknown">‚ûñ N/D</option>
        </select>

        <select id="filmFilter" aria-label="Filtrar por carrete">
            <option value="all">Todos los Carretes</option>
            <option value="yes">üéûÔ∏è Probado</option>
            <option value="no">‚è≥ No probado</option>
        </select>

        <div class="btn-group">
            <button type="button" id="resetBtn" class="btn" aria-label="Resetear todos los filtros" title="Resetear filtros">üîÑ</button>
            <button type="button" id="exportBtn" class="btn icon-btn" aria-label="Exportar a CSV" title="Exportar CSV">üíæ</button>
            <button type="button" id="printBtn" class="btn icon-btn" aria-label="Imprimir" title="Imprimir">üñ®Ô∏è</button>
            <button type="button" id="themeBtn" class="btn icon-btn" aria-label="Cambiar tema" title="Cambiar tema">üåô</button>
        </div>

        <div class="view-toggle">
            <button type="button" id="tableViewBtn" class="btn active" aria-label="Vista tabla" title="Vista tabla">üìã</button>
            <button type="button" id="cardsViewBtn" class="btn" aria-label="Vista tarjetas" title="Vista tarjetas">üé¥</button>
        </div>

        <label>
            <input type="checkbox" id="groupByBrand"> Agrupar por marca
        </label>
    </header>

    <!-- Vista Tabla -->
    <div class="view-table">
        <div class="table-wrapper" id="tableContainer">
            <table role="grid" aria-label="Colecci√≥n de c√°maras anal√≥gicas">
                <thead>
                    <tr>
                        <th data-col="brand" tabindex="0" role="columnheader" aria-sort="ascending">Marca <span class="sort-icon" aria-hidden="true">‚áÖ</span></th>
                        <th data-col="model" tabindex="0" role="columnheader">Modelo <span class="sort-icon" aria-hidden="true">‚áÖ</span></th>
                        <th data-col="serial" tabindex="0" role="columnheader">N¬∫ Serie <span class="sort-icon" aria-hidden="true">‚áÖ</span></th>
                        <th data-col="status" tabindex="0" role="columnheader">Estado <span class="sort-icon" aria-hidden="true">‚áÖ</span></th>
                        <th data-col="speeds" tabindex="0" role="columnheader">Velocidades <span class="sort-icon" aria-hidden="true">‚áÖ</span></th>
                        <th data-col="film" tabindex="0" role="columnheader">Carrete <span class="sort-icon" aria-hidden="true">‚áÖ</span></th>
                        <th data-col="loaded" tabindex="0" role="columnheader">Con Carrete <span class="sort-icon" aria-hidden="true">‚áÖ</span></th>
                        <th data-col="notes" tabindex="0" role="columnheader">Observaciones <span class="sort-icon" aria-hidden="true">‚áÖ</span></th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

    <!-- Vista Cards -->
    <div class="view-cards">
        <div class="cards-view" id="cardsContainer"></div>
    </div>
</div>

<script>
(function() {
    'use strict';

    // ============================================
    // DATOS (cargados desde JSON)
    // ============================================
    let CAMERAS = [];

    const CONFIG = Object.freeze({
        status: {
            ok:      { label: 'Funcional',   cssClass: 'st-ok' },
            warning: { label: 'Detalles',    cssClass: 'st-warn' },
            error:   { label: 'Reparar',     cssClass: 'st-err' },
            pending: { label: 'Por Revelar', cssClass: 'st-pend' }
        },
        speeds: {
            ok:      { label: 'Correctas', cssClass: 'st-ok' },
            bad:     { label: 'Fallan',    cssClass: 'st-err' },
            unknown: { label: 'N/D',       cssClass: 'st-pend' }
        },
        film: {
            yes: { label: 'Probado',    cssClass: 'st-ok' },
            no:  { label: 'No probado', cssClass: 'st-pend' }
        },
        loaded: {
            yes: { label: 'S√≠', cssClass: 'st-warn' },
            no:  { label: 'No', cssClass: 'st-pend' }
        },
        defaults: { speeds: 'unknown', film: 'no', loaded: 'no' },
        storageKey: 'cameraCollection.v2'
    });

    // ============================================
    // UTILIDADES
    // ============================================
    const collator = new Intl.Collator('es', { sensitivity: 'base', numeric: true });
    
    const Utils = {
        compareText: (a, b) => collator.compare(String(a ?? ''), String(b ?? '')),

        normalize: (value) => String(value ?? '')
            .toLowerCase()
            .normalize('NFD')
            .replace(/\p{Diacritic}/gu, '')
            .trim(),

        debounce(fn, delay = 150) {
            let timeoutId;
            return (...args) => {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => fn(...args), delay);
            };
        },

        parseSerial(serial) {
            const s = String(serial ?? '').trim();
            if (!s || s === '-') return null;
            const n = parseInt(s, 10);
            return Number.isFinite(n) ? n : null;
        },

        // Crear √≠ndice de b√∫squeda para una c√°mara
        buildSearchIndex(cam) {
            const { status, speeds, film, loaded } = CONFIG;
            const statusCfg = status[cam.status] ?? {};
            const speedsCfg = speeds[cam.speeds ?? CONFIG.defaults.speeds] ?? {};
            const filmCfg = film[cam.film ?? CONFIG.defaults.film] ?? {};
            const loadedCfg = loaded[cam.loaded ?? CONFIG.defaults.loaded] ?? {};

            return Utils.normalize([
                cam.brand, cam.model, cam.serial, cam.notes,
                cam.status, statusCfg.label,
                cam.speeds, speedsCfg.label,
                cam.film, filmCfg.label,
                cam.loaded, loadedCfg.label
            ].join(' '));
        }
    };

    // Pre-calcular √≠ndices de b√∫squeda
    let searchIndexes = new Map();

    // ============================================
    // DOM
    // ============================================
    const $ = (selector) => document.querySelector(selector);
    const $$ = (selector) => document.querySelectorAll(selector);

    const DOM = {
        tableBody: $('#tableBody'),
        cardsContainer: $('#cardsContainer'),
        tableContainer: $('#tableContainer'),
        statsDashboard: $('#statsDashboard'),
        searchInput: $('#searchInput'),
        brandFilter: $('#brandFilter'),
        statusFilter: $('#statusFilter'),
        speedsFilter: $('#speedsFilter'),
        filmFilter: $('#filmFilter'),
        resetBtn: $('#resetBtn'),
        exportBtn: $('#exportBtn'),
        printBtn: $('#printBtn'),
        themeBtn: $('#themeBtn'),
        tableViewBtn: $('#tableViewBtn'),
        cardsViewBtn: $('#cardsViewBtn'),
        groupByBrand: $('#groupByBrand'),
        countDisplay: $('#countDisplay'),
        headers: $$('th[data-col]')
    };

    // ============================================
    // ESTADO
    // ============================================
    const state = {
        sort: { column: 'brand', direction: 'asc' },
        view: 'table', // 'table' o 'cards'
        theme: 'dark', // 'dark' o 'light'
        groupByBrand: false
    };

    // ============================================
    // L√ìGICA DE NEGOCIO
    // ============================================
    const getFilters = () => ({
        search: Utils.normalize(DOM.searchInput.value),
        brand: DOM.brandFilter.value,
        status: DOM.statusFilter.value,
        speeds: DOM.speedsFilter.value,
        film: DOM.filmFilter.value
    });

    const filterCameras = (cameras, filters) => {
        const { search, brand, status, speeds, film } = filters;

        return cameras.filter(cam => {
            if (search && !searchIndexes.get(cam).includes(search)) return false;
            if (brand !== 'all' && cam.brand !== brand) return false;
            if (status !== 'all' && cam.status !== status) return false;
            if (speeds !== 'all' && (cam.speeds ?? CONFIG.defaults.speeds) !== speeds) return false;
            if (film !== 'all' && (cam.film ?? CONFIG.defaults.film) !== film) return false;
            return true;
        });
    };

    const sortCameras = (cameras, { column, direction }) => {
        const dir = direction === 'asc' ? 1 : -1;

        const comparators = {
            serial: (a, b) => {
                const numA = Utils.parseSerial(a.serial);
                const numB = Utils.parseSerial(b.serial);
                if (numA === null && numB === null) return 0;
                if (numA === null) return 1;
                if (numB === null) return -1;
                return numA - numB;
            },
            status: (a, b) => Utils.compareText(
                CONFIG.status[a.status]?.label ?? '',
                CONFIG.status[b.status]?.label ?? ''
            ),
            speeds: (a, b) => Utils.compareText(
                CONFIG.speeds[a.speeds ?? CONFIG.defaults.speeds]?.label ?? '',
                CONFIG.speeds[b.speeds ?? CONFIG.defaults.speeds]?.label ?? ''
            ),
            film: (a, b) => Utils.compareText(
                CONFIG.film[a.film ?? CONFIG.defaults.film]?.label ?? '',
                CONFIG.film[b.film ?? CONFIG.defaults.film]?.label ?? ''
            ),
            loaded: (a, b) => Utils.compareText(
                CONFIG.loaded[a.loaded ?? CONFIG.defaults.loaded]?.label ?? '',
                CONFIG.loaded[b.loaded ?? CONFIG.defaults.loaded]?.label ?? ''
            ),
            default: (a, b) => Utils.compareText(a[column] ?? '', b[column] ?? '')
        };

        const compare = comparators[column] ?? comparators.default;

        return [...cameras].sort((a, b) => {
            const cmp = compare(a, b);
            if (cmp !== 0) return cmp * dir;
            // Desempate estable
            return Utils.compareText(
                `${a.brand} ${a.model} ${a.serial}`,
                `${b.brand} ${b.model} ${b.serial}`
            );
        });
    };

    // ============================================
    // RENDERIZADO (sin innerHTML para datos)
    // ============================================
    const createBadge = (text, cssClass) => {
        const span = document.createElement('span');
        span.className = `badge ${cssClass}`;
        span.textContent = text;
        return span;
    };

    const createCell = (text, className) => {
        const td = document.createElement('td');
        if (className) td.className = className;
        td.textContent = text;
        return td;
    };

    const createRow = (cam) => {
        const tr = document.createElement('tr');
        const st = CONFIG.status[cam.status];
        const sp = CONFIG.speeds[cam.speeds ?? CONFIG.defaults.speeds];
        const fm = CONFIG.film[cam.film ?? CONFIG.defaults.film];
        const ld = CONFIG.loaded[cam.loaded ?? CONFIG.defaults.loaded];

        // Agregar clases para resaltado
        if (cam.status === 'error') tr.classList.add('urgent');
        if (cam.loaded === 'yes') tr.classList.add('has-film');

        tr.appendChild(createCell(cam.brand, 'col-brand'));
        tr.appendChild(createCell(cam.model, 'col-model'));
        tr.appendChild(createCell(cam.serial, 'col-serial'));

        const statusCell = document.createElement('td');
        statusCell.className = 'col-status';
        statusCell.appendChild(createBadge(st.label, st.cssClass));
        tr.appendChild(statusCell);

        const speedsCell = document.createElement('td');
        speedsCell.className = 'col-speeds';
        speedsCell.appendChild(createBadge(sp.label, sp.cssClass));
        tr.appendChild(speedsCell);

        const filmCell = document.createElement('td');
        filmCell.className = 'col-film';
        filmCell.appendChild(createBadge(fm.label, fm.cssClass));
        tr.appendChild(filmCell);

        const loadedCell = document.createElement('td');
        loadedCell.className = 'col-loaded';
        loadedCell.appendChild(createBadge(ld.label, ld.cssClass));
        tr.appendChild(loadedCell);

        tr.appendChild(createCell(cam.notes, 'col-notes'));

        return tr;
    };

    const createCard = (cam) => {
        const card = document.createElement('div');
        card.className = 'camera-card';
        
        if (cam.status === 'error') card.classList.add('urgent');
        if (cam.loaded === 'yes') card.classList.add('has-film');

        const st = CONFIG.status[cam.status];
        const sp = CONFIG.speeds[cam.speeds ?? CONFIG.defaults.speeds];
        const fm = CONFIG.film[cam.film ?? CONFIG.defaults.film];
        const ld = CONFIG.loaded[cam.loaded ?? CONFIG.defaults.loaded];

        // Header
        const header = document.createElement('div');
        header.className = 'card-header';
        
        const brand = document.createElement('div');
        brand.className = 'card-brand';
        brand.textContent = cam.brand;
        
        const model = document.createElement('div');
        model.className = 'card-model';
        model.textContent = cam.model;
        
        const serial = document.createElement('div');
        serial.className = 'card-serial';
        serial.textContent = `S/N: ${cam.serial}`;
        
        header.appendChild(brand);
        header.appendChild(model);
        header.appendChild(serial);

        // Info
        const info = document.createElement('div');
        info.className = 'card-info';

        const createInfoRow = (label, badge) => {
            const row = document.createElement('div');
            row.className = 'card-info-row';
            const labelSpan = document.createElement('span');
            labelSpan.textContent = label;
            row.appendChild(labelSpan);
            row.appendChild(badge);
            return row;
        };

        info.appendChild(createInfoRow('Estado:', createBadge(st.label, st.cssClass)));
        info.appendChild(createInfoRow('Velocidades:', createBadge(sp.label, sp.cssClass)));
        info.appendChild(createInfoRow('Carrete:', createBadge(fm.label, fm.cssClass)));
        info.appendChild(createInfoRow('Con Carrete:', createBadge(ld.label, ld.cssClass)));

        // Notes
        const notes = document.createElement('div');
        notes.className = 'card-notes';
        notes.textContent = cam.notes || 'Sin observaciones';

        card.appendChild(header);
        card.appendChild(info);
        card.appendChild(notes);

        return card;
    };

    const renderStats = (cameras) => {
        const stats = {
            total: cameras.length,
            ok: cameras.filter(c => c.status === 'ok').length,
            warning: cameras.filter(c => c.status === 'warning').length,
            error: cameras.filter(c => c.status === 'error').length,
            pending: cameras.filter(c => c.status === 'pending').length,
            withFilm: cameras.filter(c => c.loaded === 'yes').length
        };

        const dashboard = DOM.statsDashboard;
        dashboard.innerHTML = '';

        const createStatCard = (number, label, color) => {
            const card = document.createElement('div');
            card.className = 'stat-card';
            
            const num = document.createElement('div');
            num.className = 'stat-number';
            num.textContent = number;
            num.style.color = color;
            
            const lbl = document.createElement('div');
            lbl.className = 'stat-label';
            lbl.textContent = label;
            
            card.appendChild(num);
            card.appendChild(lbl);
            return card;
        };

        dashboard.appendChild(createStatCard(stats.total, 'Total', 'var(--accent)'));
        dashboard.appendChild(createStatCard(stats.ok, 'Funcionales', 'var(--ok-tx)'));
        dashboard.appendChild(createStatCard(stats.warning, 'Con detalles', 'var(--warn-tx)'));
        dashboard.appendChild(createStatCard(stats.error, 'A reparar', 'var(--err-tx)'));
        dashboard.appendChild(createStatCard(stats.withFilm, 'Cargadas', 'var(--warn-tx)'));
    };

    const renderTable = (cameras) => {
        const tbody = DOM.tableBody;
        tbody.innerHTML = '';

        if (cameras.length === 0) {
            const tr = document.createElement('tr');
            const td = document.createElement('td');
            td.colSpan = 8;
            td.className = 'empty-state';
            td.textContent = 'No se encontraron c√°maras con los filtros seleccionados';
            tr.appendChild(td);
            tbody.appendChild(tr);
        } else {
            const fragment = document.createDocumentFragment();
            cameras.forEach(cam => fragment.appendChild(createRow(cam)));
            tbody.appendChild(fragment);
        }

        DOM.countDisplay.textContent = cameras.length;
    };

    const renderCards = (cameras) => {
        const container = DOM.cardsContainer;
        container.innerHTML = '';

        if (cameras.length === 0) {
            const empty = document.createElement('div');
            empty.className = 'empty-state';
            empty.textContent = 'No se encontraron c√°maras con los filtros seleccionados';
            container.appendChild(empty);
        } else {
            const fragment = document.createDocumentFragment();
            cameras.forEach(cam => fragment.appendChild(createCard(cam)));
            container.appendChild(fragment);
        }

        DOM.countDisplay.textContent = cameras.length;
    };

    const renderGroupedTable = (cameras) => {
        const container = DOM.tableContainer;
        container.innerHTML = '';

        if (cameras.length === 0) {
            const empty = document.createElement('div');
            empty.className = 'empty-state';
            empty.textContent = 'No se encontraron c√°maras con los filtros seleccionados';
            container.appendChild(empty);
            return;
        }

        // Agrupar por marca
        const groups = {};
        cameras.forEach(cam => {
            if (!groups[cam.brand]) groups[cam.brand] = [];
            groups[cam.brand].push(cam);
        });

        const fragment = document.createDocumentFragment();

        Object.keys(groups).sort(Utils.compareText).forEach(brand => {
            const brandCameras = groups[brand];
            
            const group = document.createElement('div');
            group.className = 'brand-group';
            
            const header = document.createElement('div');
            header.className = 'brand-group-header';
            header.innerHTML = `${brand} <span class="brand-group-count">${brandCameras.length} c√°mara${brandCameras.length > 1 ? 's' : ''}</span>`;
            header.addEventListener('click', () => {
                group.classList.toggle('collapsed');
            });
            
            const content = document.createElement('div');
            content.className = 'brand-group-content';
            
            const table = document.createElement('table');
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>Modelo</th>
                        <th>N¬∫ Serie</th>
                        <th>Estado</th>
                        <th>Velocidades</th>
                        <th>Carrete</th>
                        <th>Con Carrete</th>
                        <th>Observaciones</th>
                    </tr>
                </thead>
            `;
            
            const tbody = document.createElement('tbody');
            brandCameras.forEach(cam => {
                const tr = document.createElement('tr');
                if (cam.status === 'error') tr.classList.add('urgent');
                if (cam.loaded === 'yes') tr.classList.add('has-film');
                
                const st = CONFIG.status[cam.status];
                const sp = CONFIG.speeds[cam.speeds ?? CONFIG.defaults.speeds];
                const fm = CONFIG.film[cam.film ?? CONFIG.defaults.film];
                const ld = CONFIG.loaded[cam.loaded ?? CONFIG.defaults.loaded];
                
                tr.appendChild(createCell(cam.model, 'col-model'));
                tr.appendChild(createCell(cam.serial, 'col-serial'));
                
                const statusCell = document.createElement('td');
                statusCell.appendChild(createBadge(st.label, st.cssClass));
                tr.appendChild(statusCell);
                
                const speedsCell = document.createElement('td');
                speedsCell.appendChild(createBadge(sp.label, sp.cssClass));
                tr.appendChild(speedsCell);
                
                const filmCell = document.createElement('td');
                filmCell.appendChild(createBadge(fm.label, fm.cssClass));
                tr.appendChild(filmCell);
                
                const loadedCell = document.createElement('td');
                loadedCell.appendChild(createBadge(ld.label, ld.cssClass));
                tr.appendChild(loadedCell);
                
                tr.appendChild(createCell(cam.notes, 'col-notes'));
                
                tbody.appendChild(tr);
            });
            
            table.appendChild(tbody);
            content.appendChild(table);
            group.appendChild(header);
            group.appendChild(content);
            fragment.appendChild(group);
        });

        container.appendChild(fragment);
        DOM.countDisplay.textContent = cameras.length;
    };

    const updateHeaderIcons = () => {
        DOM.headers.forEach(th => {
            const col = th.dataset.col;
            const isActive = col === state.sort.column;
            const icon = th.querySelector('.sort-icon');

            th.classList.toggle('active', isActive);
            th.setAttribute('aria-sort', 
                isActive ? (state.sort.direction === 'asc' ? 'ascending' : 'descending') : 'none'
            );
            icon.textContent = isActive 
                ? (state.sort.direction === 'asc' ? '‚Üë' : '‚Üì') 
                : '‚áÖ';
        });
    };

    const render = () => {
        const filters = getFilters();
        const filtered = filterCameras(CAMERAS, filters);
        const sorted = sortCameras(filtered, state.sort);
        
        renderStats(CAMERAS); // Siempre mostrar stats de todas las c√°maras
        
        if (state.groupByBrand && state.view === 'table') {
            renderGroupedTable(sorted);
        } else if (state.view === 'table') {
            renderTable(sorted);
        } else {
            renderCards(sorted);
        }
        
        updateHeaderIcons();
    };

    const scheduleRender = Utils.debounce(render, 150);

    // ============================================
    // PERSISTENCIA
    // ============================================
    const Storage = {
        save() {
            const payload = {
                sort: state.sort,
                view: state.view,
                theme: state.theme,
                groupByBrand: state.groupByBrand,
                filters: {
                    search: DOM.searchInput.value,
                    brand: DOM.brandFilter.value,
                    status: DOM.statusFilter.value,
                    speeds: DOM.speedsFilter.value,
                    film: DOM.filmFilter.value
                }
            };
            try {
                localStorage.setItem(CONFIG.storageKey, JSON.stringify(payload));
            } catch { /* Silenciar errores de quota */ }
        },

        load() {
            try {
                const raw = localStorage.getItem(CONFIG.storageKey);
                if (!raw) return;
                
                const data = JSON.parse(raw);
                if (data?.sort?.column) state.sort = data.sort;
                if (data?.view) state.view = data.view;
                if (data?.theme) state.theme = data.theme;
                if (data?.groupByBrand !== undefined) state.groupByBrand = data.groupByBrand;

                if (data?.filters) {
                    const f = data.filters;
                    DOM.searchInput.value = f.search ?? '';
                    DOM.brandFilter.value = f.brand ?? 'all';
                    DOM.statusFilter.value = f.status ?? 'all';
                    DOM.speedsFilter.value = f.speeds ?? 'all';
                    DOM.filmFilter.value = f.film ?? 'all';
                }
            } catch { /* Datos corruptos, ignorar */ }
        }
    };

    // ============================================
    // CARGA DE DATOS
    // ============================================
    const loadCameras = async () => {
        try {
            const response = await fetch('cameras.json');
            if (!response.ok) throw new Error('Error al cargar datos');
            
            const data = await response.json();
            CAMERAS = Object.freeze(data);
            searchIndexes = new Map(CAMERAS.map(cam => [cam, Utils.buildSearchIndex(cam)]));
            
            return true;
        } catch (error) {
            console.error('Error cargando c√°maras:', error);
            DOM.tableBody.innerHTML = `
                <tr><td colspan="8" class="empty-state">
                    ‚ùå Error al cargar los datos. Por favor, recarga la p√°gina.
                </td></tr>
            `;
            return false;
        }
    };

    // ============================================
    // INICIALIZACI√ìN
    // ============================================
    const populateBrandFilter = () => {
        const brands = [...new Set(CAMERAS.map(c => c.brand))].sort(Utils.compareText);
        const fragment = document.createDocumentFragment();

        const allOption = document.createElement('option');
        allOption.value = 'all';
        allOption.textContent = 'Todas las Marcas';
        fragment.appendChild(allOption);

        brands.forEach(brand => {
            const opt = document.createElement('option');
            opt.value = brand;
            opt.textContent = brand;
            fragment.appendChild(opt);
        });

        DOM.brandFilter.innerHTML = '';
        DOM.brandFilter.appendChild(fragment);
    };

    const resetFilters = () => {
        DOM.searchInput.value = '';
        DOM.brandFilter.value = 'all';
        DOM.statusFilter.value = 'all';
        DOM.speedsFilter.value = 'all';
        DOM.filmFilter.value = 'all';
        state.sort = { column: 'brand', direction: 'asc' };
        Storage.save();
        render();
        DOM.searchInput.focus();
    };

    const toggleTheme = () => {
        state.theme = state.theme === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', state.theme);
        DOM.themeBtn.textContent = state.theme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
        Storage.save();
    };

    const toggleView = (view) => {
        state.view = view;
        document.body.classList.toggle('cards-mode', view === 'cards');
        DOM.tableViewBtn.classList.toggle('active', view === 'table');
        DOM.cardsViewBtn.classList.toggle('active', view === 'cards');
        Storage.save();
        render();
    };

    const toggleGrouping = () => {
        state.groupByBrand = DOM.groupByBrand.checked;
        Storage.save();
        render();
    };

    const exportToCSV = () => {
        const filters = getFilters();
        const filtered = filterCameras(CAMERAS, filters);
        const sorted = sortCameras(filtered, state.sort);

        const headers = ['Marca', 'Modelo', 'N¬∫ Serie', 'Estado', 'Velocidades', 'Carrete', 'Con Carrete', 'Observaciones'];
        const rows = sorted.map(cam => {
            const st = CONFIG.status[cam.status]?.label ?? '';
            const sp = CONFIG.speeds[cam.speeds ?? CONFIG.defaults.speeds]?.label ?? '';
            const fm = CONFIG.film[cam.film ?? CONFIG.defaults.film]?.label ?? '';
            const ld = CONFIG.loaded[cam.loaded ?? CONFIG.defaults.loaded]?.label ?? '';
            
            return [
                cam.brand,
                cam.model,
                cam.serial,
                st,
                sp,
                fm,
                ld,
                cam.notes
            ].map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',');
        });

        const csv = [headers.join(','), ...rows].join('\n');
        const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `camaras_${new Date().toISOString().split('T')[0]}.csv`;
        link.click();
        URL.revokeObjectURL(link.href);
    };

    const printTable = () => {
        window.print();
    };

    const handleSort = (column) => {
        if (state.sort.column === column) {
            state.sort.direction = state.sort.direction === 'asc' ? 'desc' : 'asc';
        } else {
            state.sort.column = column;
            state.sort.direction = 'asc';
        }
        Storage.save();
        render();
    };

    const init = async () => {
        // Mostrar estado de carga
        DOM.tableBody.innerHTML = `
            <tr><td colspan="8" class="empty-state">
                Cargando datos...
            </td></tr>
        `;

        // Cargar datos desde JSON
        const loaded = await loadCameras();
        if (!loaded) return;

        populateBrandFilter();
        Storage.load();

        // Aplicar tema guardado
        document.documentElement.setAttribute('data-theme', state.theme);
        DOM.themeBtn.textContent = state.theme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
        
        // Aplicar vista guardada
        document.body.classList.toggle('cards-mode', state.view === 'cards');
        DOM.tableViewBtn.classList.toggle('active', state.view === 'table');
        DOM.cardsViewBtn.classList.toggle('active', state.view === 'cards');
        
        // Aplicar agrupaci√≥n guardada
        DOM.groupByBrand.checked = state.groupByBrand;

        // Event listeners con delegaci√≥n donde sea posible
        DOM.searchInput.addEventListener('input', () => { Storage.save(); scheduleRender(); });
        
        [DOM.brandFilter, DOM.statusFilter, DOM.speedsFilter, DOM.filmFilter].forEach(el => {
            el.addEventListener('change', () => { Storage.save(); render(); });
        });

        DOM.resetBtn.addEventListener('click', resetFilters);
        DOM.exportBtn.addEventListener('click', exportToCSV);
        DOM.printBtn.addEventListener('click', printTable);
        DOM.themeBtn.addEventListener('click', toggleTheme);
        DOM.tableViewBtn.addEventListener('click', () => toggleView('table'));
        DOM.cardsViewBtn.addEventListener('click', () => toggleView('cards'));
        DOM.groupByBrand.addEventListener('change', toggleGrouping);

        // Delegaci√≥n para headers
        const thead = document.querySelector('thead');
        thead.addEventListener('click', (e) => {
            const th = e.target.closest('th[data-col]');
            if (th) handleSort(th.dataset.col);
        });

        thead.addEventListener('keydown', (e) => {
            const th = e.target.closest('th[data-col]');
            if (th && (e.key === 'Enter' || e.key === ' ')) {
                e.preventDefault();
                handleSort(th.dataset.col);
            }
        });

        render();
    };

    // Iniciar
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }
})();
</script>
</body>
</html>
